<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiableAuto ‚Äì Web App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body data-theme="light">
  <header>
    <h1>üöó FiableAuto</h1>
  </header>

  <!-- Navigation -->
  <nav class="nav">
    <button class="nav-pill active" data-section="gestionnaire"><i class="fas fa-user-tie"></i> Gestionnaire</button>
    <button class="nav-pill" data-section="prestataire"><i class="fas fa-user-cog"></i> Prestataire</button>
    <button class="nav-pill" data-section="client"><i class="fas fa-user"></i> Client</button>
  </nav>

  <!-- GESTIONNAIRE -->
  <section id="gestionnaire" class="section active">
    <!-- Stats Dashboard -->
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalMissions">0</h3>
          <p>Missions cr√©√©es</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingMissions">0</h3>
          <p>En attente</p>
        </div>
        <div class="stat-card">
          <h3 id="progressMissions">0</h3>
          <p>En cours</p>
        </div>
        <div class="stat-card">
          <h3 id="completedMissions">0</h3>
          <p>Termin√©es</p>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>Cr√©er une mission</h2>
      <form id="missionForm" class="enhanced-form">
        <div class="form-grid">
          <input type="text" name="vehicleBrand" placeholder="Marque" required>
          <input type="text" name="vehicleModel" placeholder="Mod√®le" required>
          <input type="number" name="vehicleYear" placeholder="Ann√©e">
          <input type="text" name="licensePlate" placeholder="Immatriculation">
          <input type="number" name="mileage" placeholder="Kilom√©trage">
          <input type="text" name="pickupLocation" placeholder="Lieu prise en charge" required>
          <input type="text" name="deliveryLocation" placeholder="Lieu livraison" required>
          <input type="date" name="pickupDate">
          <input type="date" name="deliveryDate">
          <input type="text" name="clientName" placeholder="Nom client" required>
          <input type="email" name="clientEmail" placeholder="Email client" required>
          <input type="text" name="clientPhone" placeholder="T√©l√©phone client">
        </div>
        <button type="submit" class="btn-enhanced btn-primary">Cr√©er mission</button>
      </form>

      <h3>Missions archiv√©es</h3>
      <div id="missionsList"></div>
    </div>
  </section>

  <!-- PRESTATAIRE -->
  <section id="prestataire" class="section">
    <div class="container">
      <h2>Acc√©der √† une mission</h2>
      <form id="accessForm" class="enhanced-form">
        <input type="text" id="missionCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Acc√©der</button>
      </form>

      <div id="missionDetails" style="display:none; margin-top:20px;">
        <div id="missionInfo"></div>

        <!-- Phase D√©part -->
        <div id="departurePhase" class="mission-phase">
          <h3 class="phase-title"><i class="fas fa-play-circle"></i> Phase D√©part</h3>
          
          <!-- Checklist -->
          <div id="checklist" class="enhanced-form-section">
            <div class="section-title"><i class="fas fa-list-check"></i> Checklist</div>
            <label><input type="checkbox" name="vehiclePapers" value="ok"> Papiers v√©hicule OK</label>
            <label><input type="checkbox" name="gps" value="ok"> GPS fonctionnel</label>
            <label><input type="checkbox" name="sdCard" value="ok"> Carte SD pr√©sente</label>
            <label><input type="checkbox" name="safetyKit" value="ok"> Kit s√©curit√© complet</label>
            <label><input type="checkbox" name="spareWheel" value="ok"> Roue de secours</label>
          </div>

          <!-- Photos de d√©part AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos de d√©part</h4>
            <div class="photo-grid" id="departurePhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur</label>
                </div>
                <input type="file" data-photo="compteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car photo-icon"></i>
                  <label>Face avant</label>
                </div>
                <input type="file" data-photo="face-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-rear photo-icon"></i>
                  <label>Face arri√®re</label>
                </div>
                <input type="file" data-photo="face-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral gauche avant</label>
                </div>
                <input type="file" data-photo="lateral-gauche-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral gauche arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-gauche-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral droit avant</label>
                </div>
                <input type="file" data-photo="lateral-droit-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral droit arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-droit-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-cog photo-icon"></i>
                  <label>Moteur</label>
                </div>
                <input type="file" data-photo="moteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-chair photo-icon"></i>
                  <label>Int√©rieur</label>
                </div>
                <input type="file" data-photo="interieur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-book photo-icon"></i>
                  <label>Carnet d'entretien</label>
                </div>
                <input type="file" data-photo="carnet" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations de d√©part -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations de d√©part</h4>
            <textarea id="departureObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule au d√©part..."></textarea>
          </div>

          <button type="button" id="validateDeparture" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check"></i> Valider D√©part
          </button>
        </div>

        <!-- Phase Arriv√©e -->
        <div id="arrivalPhase" class="mission-phase" style="display:none;">
          <h3 class="phase-title"><i class="fas fa-flag-checkered"></i> Phase Arriv√©e</h3>
          
          <!-- Photos d'arriv√©e AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos d'arriv√©e</h4>
            <div class="photo-grid" id="arrivalPhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur final</label>
                </div>
                <input type="file" data-photo="compteur-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-crash photo-icon"></i>
                  <label>√âtat g√©n√©ral final</label>
                </div>
                <input type="file" data-photo="etat-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-key photo-icon"></i>
                  <label>Remise cl√©s</label>
                </div>
                <input type="file" data-photo="remise-cles" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations d'arriv√©e -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations d'arriv√©e</h4>
            <textarea id="arrivalObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule √† l'arriv√©e..."></textarea>
          </div>

          <!-- Signature client -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-signature"></i> Signature du client</h4>
            <div class="signature-section">
              <canvas id="signatureCanvas" width="500" height="200"></canvas>
              <div class="signature-controls">
                <button type="button" id="clearSignature" class="btn-enhanced btn-secondary">
                  <i class="fas fa-eraser"></i> Effacer
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="finalizeMission" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check-double"></i> Finaliser Mission
          </button>
        </div>

        <!-- √âcran de fin -->
        <div id="completionScreen" class="completion-screen" style="display:none;">
          <div class="completion-content">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>Mission Finalis√©e avec Succ√®s !</h3>
            <p>La mission a √©t√© compl√©t√©e et le rapport est disponible.</p>
            <button type="button" id="returnToHome" class="btn-enhanced btn-primary">
              <i class="fas fa-home"></i> Retour Accueil Prestataire
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENT -->
  <section id="client" class="section">
    <div class="container">
      <h2>Suivi de mission</h2>
      <form id="trackingForm" class="enhanced-form">
        <input type="text" id="trackingCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Suivre ma mission</button>
      </form>
      
      <div id="trackingResult" style="display:none;">
        <div id="trackingInfo"></div>
        
        <!-- Statut de progression -->
        <div id="progressTracker" class="progress-tracker">
          <div class="progress-step" data-step="created">
            <div class="step-icon"><i class="fas fa-plus"></i></div>
            <div class="step-label">Mission cr√©√©e</div>
          </div>
          <div class="progress-step" data-step="in-progress">
            <div class="step-icon"><i class="fas fa-road"></i></div>
            <div class="step-label">En cours</div>
          </div>
          <div class="progress-step" data-step="departure-validated">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div class="step-label">D√©part valid√©</div>
          </div>
          <div class="progress-step" data-step="completed">
            <div class="step-icon"><i class="fas fa-flag-checkered"></i></div>
            <div class="step-label">Termin√©e</div>
          </div>
        </div>

        <!-- Section rapport -->
        <div id="downloadSection" style="display:none;">
          <div class="report-section">
            <h4><i class="fas fa-file-pdf"></i> Rapport de mission</h4>
            <div class="report-actions">
              <button id="downloadReport" class="btn-enhanced btn-success">
                <i class="fas fa-download"></i> T√©l√©charger rapport PDF
              </button>
              <button id="emailReport" class="btn-enhanced btn-secondary">
                <i class="fas fa-envelope"></i> Envoyer par email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notifications et Loading -->
  <div id="notification" class="notification"></div>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
  </div>

  <script src="script.js"></script>

<!-- üöÄ FIABLEAUTO PATCH FINAL v3.0 - PRODUCTION READY -->

<script>
/**
 * FiableAuto Mobile + PDF Fix
 * Version: 3.0.0 - Production Ready
 * Corrige: Mobile UX + Finalisation + PDF Download
 */
(function() {
    'use strict';
    
    console.log('üöÄ FiableAuto Patch Final v3.0 - Initialisation...');
    
    // Configuration
    const CONFIG = {
        API_BASE_URL: 'https://fiableauto-production-production.up.railway.app/api'
    };
    
    // √âtat global
    window.fiableAutoState = {
        departureValidated: false,
        missionCompleted: false,
        departurePhotos: 0,
        arrivalPhotos: 0,
        checkboxes: 0,
        currentMission: null
    };
    
    // Initialisation avec d√©lai
    setTimeout(function() {
        try {
            initializeMobilePatch();
            console.log('‚úÖ Patch Final v3.0 appliqu√© avec succ√®s');
        } catch (error) {
            console.error('‚ùå Erreur initialisation:', error);
        }
    }, 2000);
    
    function initializeMobilePatch() {
        // R√©cup√©rer mission actuelle
        if (window.app && window.app.currentMission) {
            window.fiableAutoState.currentMission = window.app.currentMission;
            console.log('üìã Mission active:', window.fiableAutoState.currentMission.mission_code);
        }
        
        // 1. OPTIMISATIONS MOBILE
        optimizeMobile();
        
        // 2. PHOTOS ENHANCED
        setupEnhancedPhotos();
        
        // 3. CHECKBOXES
        setupEnhancedCheckboxes();
        
        // 4. VALIDATION D√âPART
        setupDepartureValidation();
        
        // 5. FINALISATION
        setupMissionFinalization();
        
        // 6. PDF DOWNLOAD FIX
        fixPDFDownload();
    }
    
    // OPTIMISATIONS MOBILE
    function optimizeMobile() {
        // Textarea mobile-friendly
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.style.fontSize = '16px';
            textarea.removeAttribute('readonly');
            
            textarea.addEventListener('touchstart', function(e) {
                e.stopPropagation();
                this.focus();
            }, { passive: false });
        });
        
        console.log('‚úÖ Optimisations mobile appliqu√©es');
    }
    
    // PHOTOS ENHANCED
    function setupEnhancedPhotos() {
        document.querySelectorAll('#departurePhotos input[type="file"], #arrivalPhotos input[type="file"]').forEach(input => {
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            const card = newInput.closest('.photo-card');
            const phase = newInput.closest('#departurePhotos') ? 'departure' : 'arrival';
            const photoType = newInput.dataset.photo;
            
            newInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Validation
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Fichier doit √™tre une image');
                    }
                    
                    // Preview local
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let preview = card.querySelector('.photo-preview');
                        if (!preview) {
                            preview = document.createElement('img');
                            preview.className = 'photo-preview';
                            preview.style.cssText = 'max-width: 100%; max-height: 120px; border-radius: 6px; margin-top: 8px; display: block;';
                            card.appendChild(preview);
                        }
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Marquer upload√©e
                    card.classList.add('uploaded');
                    
                    // Upload serveur si possible
                    if (window.fiableAutoState.currentMission) {
                        try {
                            const formData = new FormData();
                            formData.append('photo', file);
                            formData.append('photoType', `${phase}:${photoType}`);
                            
                            const response = await fetch(`${CONFIG.API_BASE_URL}/uploads/photos/${window.fiableAutoState.currentMission.id}`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (response.ok) {
                                console.log(`‚úÖ Photo ${photoType} upload√©e`);
                            }
                        } catch (uploadError) {
                            console.warn(`‚ö†Ô∏è Upload serveur √©chou√©:`, uploadError);
                        }
                    }
                    
                    updateCounters();
                    showToast(`üì∏ Photo ${photoType} ajout√©e`, 'success');
                    
                } catch (error) {
                    console.error('Erreur upload:', error);
                    showToast(`Erreur: ${error.message}`, 'error');
                }
            });
            
            // Click sur card
            card.addEventListener('click', function(e) {
                if (e.target !== newInput) {
                    newInput.click();
                }
            });
        });
    }
    
    // CHECKBOXES ENHANCED
    function setupEnhancedCheckboxes() {
        document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
            const newCheckbox = checkbox.cloneNode(true);
            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            
            newCheckbox.addEventListener('change', function() {
                window.fiableAutoState.checkboxes = document.querySelectorAll('#checklist input:checked').length;
                updateCounters();
                
                const label = this.closest('label');
                if (label) {
                    label.style.backgroundColor = this.checked ? 'rgba(16, 185, 129, 0.1)' : '';
                    label.style.borderColor = this.checked ? '#10b981' : '';
                }
            });
        });
    }
    
    // VALIDATION D√âPART
    function setupDepartureValidation() {
        const validateBtn = document.getElementById('validateDeparture');
        if (!validateBtn) return;
        
        const newValidateBtn = validateBtn.cloneNode(true);
        validateBtn.parentNode.replaceChild(newValidateBtn, validateBtn);
        
        newValidateBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            if (window.fiableAutoState.checkboxes < 5) {
                showToast('‚ùå Cochez les 5 cases requises', 'warning');
                return;
            }
            
            if (window.fiableAutoState.departurePhotos < 10) {
                showToast('‚ùå Ajoutez les 10 photos de d√©part', 'warning');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';
            
            try {
                // Sauvegarde serveur
                if (window.fiableAutoState.currentMission) {
                    const departureData = {
                        phase: 'departure',
                        observations: document.getElementById('departureObservations')?.value || '',
                        checklist: getChecklistData(),
                        photos: Array.from(document.querySelectorAll('#departurePhotos .uploaded')).map((_, i) => `photo-${i}`),
                        timestamp: new Date().toISOString()
                    };
                    
                    await fetch(`${CONFIG.API_BASE_URL}/missions/${window.fiableAutoState.currentMission.id}/departure-data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(departureData)
                    });
                    
                    await fetch(`${CONFIG.API_BASE_URL}/missions/${window.fiableAutoState.currentMission.id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'departure_validated' })
                    });
                }
                
                // Interface
                window.fiableAutoState.departureValidated = true;
                this.innerHTML = '‚úÖ D√©part Valid√©';
                this.style.background = '#10b981';
                
                // Transition
                setTimeout(() => {
                    document.getElementById('departurePhase').style.display = 'none';
                    const arrivalPhase = document.getElementById('arrivalPhase');
                    arrivalPhase.style.display = 'block';
                    arrivalPhase.scrollIntoView({ behavior: 'smooth' });
                }, 1000);
                
                showToast('‚úÖ EDL D√©part valid√©', 'success');
                
            } catch (error) {
                console.error('Erreur validation:', error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check"></i> Valider D√©part';
                showToast('Erreur: ' + error.message, 'error');
            }
        });
    }
    
    // FINALISATION MISSION
    function setupMissionFinalization() {
        const finalizeBtn = document.getElementById('finalizeMission');
        if (!finalizeBtn) return;
        
        const newFinalizeBtn = finalizeBtn.cloneNode(true);
        finalizeBtn.parentNode.replaceChild(newFinalizeBtn, finalizeBtn);
        
        newFinalizeBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            if (!window.fiableAutoState.departureValidated) {
                showToast('‚ùå Validez d\'abord l\'EDL D√©part', 'warning');
                return;
            }
            
            if (window.fiableAutoState.arrivalPhotos < 3) {
                showToast('‚ùå Ajoutez les 3 photos d\'arriv√©e', 'warning');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalisation...';
            
            try {
                // Sauvegarde serveur
                if (window.fiableAutoState.currentMission) {
                    const arrivalData = {
                        phase: 'arrival',
                        observations: document.getElementById('arrivalObservations')?.value || '',
                        signature: getSignatureData(),
                        photos: Array.from(document.querySelectorAll('#arrivalPhotos .uploaded')).map((_, i) => `arrival-photo-${i}`),
                        timestamp: new Date().toISOString()
                    };
                    
                    await fetch(`${CONFIG.API_BASE_URL}/missions/${window.fiableAutoState.currentMission.id}/arrival-data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(arrivalData)
                    });
                    
                    await fetch(`${CONFIG.API_BASE_URL}/missions/${window.fiableAutoState.currentMission.id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    
                    console.log('‚úÖ Mission marqu√©e comme completed');
                }
                
                // Interface
                window.fiableAutoState.missionCompleted = true;
                this.innerHTML = 'üéâ Mission Finalis√©e';
                this.style.background = '#10b981';
                
                // √âcran succ√®s
                showCompletionScreen();
                
                // Recharger stats
                setTimeout(() => {
                    if (window.app && window.app.loadStats) {
                        window.app.loadStats();
                        window.app.loadAllMissions();
                    }
                }, 2000);
                
                showToast('üéâ Mission finalis√©e avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur finalisation:', error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-double"></i> Finaliser Mission';
                showToast('Erreur: ' + error.message, 'error');
            }
        });
    }
    
    // FIX PDF DOWNLOAD
    function fixPDFDownload() {
        // Intercepter tous les clics sur t√©l√©charger rapport
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('button');
            if (!btn || !btn.textContent.includes('T√©l√©charger Rapport')) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            // Extraire code mission de la card
            const card = btn.closest('.mission-card');
            let missionCode = null;
            
            if (card) {
                const codeText = Array.from(card.querySelectorAll('p')).find(p => p.textContent.includes('Code:'));
                if (codeText) {
                    missionCode = codeText.textContent.replace('Code:', '').trim();
                }
            }
            
            if (missionCode) {
                downloadPDFAlternative(missionCode);
            } else {
                showToast('‚ùå Code mission introuvable', 'error');
            }
        });
    }
    
    // T√âL√âCHARGEMENT PDF ALTERNATIF
    function downloadPDFAlternative(missionCode) {
        console.log('üìÑ T√©l√©chargement PDF alternatif pour:', missionCode);
        
        showToast('üìÑ G√©n√©ration du rapport PDF...', 'info');
        
        // Cr√©er rapport HTML professionnel
        const reportHTML = generatePDFReport(missionCode);
        
        // Ouvrir dans nouvelle fen√™tre
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(reportHTML);
        printWindow.document.close();
        
        // Auto-print apr√®s chargement
        setTimeout(() => {
            printWindow.print();
        }, 1000);
        
        showToast('üìÑ Rapport ouvert - Utilisez Ctrl+P pour sauvegarder en PDF', 'success');
    }
    
    // G√âN√âRATION RAPPORT HTML PROFESSIONNEL
    function generatePDFReport(missionCode) {
        const mission = window.fiableAutoState.currentMission;
        const now = new Date();
        
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Rapport Mission ${missionCode}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            line-height: 1.4; 
            color: #333; 
            background: white;
            padding: 20px;
        }
        .header {
            border-bottom: 3px solid #1e3a8a;
            padding-bottom: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #1e3a8a;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header .subtitle {
            color: #64748b;
            font-size: 1.2em;
        }
        .mission-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #f97316;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .info-item strong {
            color: #1e3a8a;
            display: block;
            margin-bottom: 5px;
        }
        .status-badge {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            display: inline-block;
            margin-top: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h2 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #f97316;
            padding-bottom: 5px;
        }
        .checklist {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .check {
            color: #10b981;
            font-weight: bold;
            font-size: 1.2em;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            color: #64748b;
            font-size: 0.9em;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }
        .photo-section {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        @media print {
            body { padding: 0; }
            .header { page-break-after: avoid; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó FIABLEAUTO</h1>
        <div class="subtitle">Rapport de Mission Automobile</div>
    </div>
    
    <div class="mission-info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Code Mission</strong>
                ${missionCode}
                <span class="status-badge">TERMIN√âE</span>
            </div>
            <div class="info-item">
                <strong>Date de g√©n√©ration</strong>
                ${now.toLocaleDateString('fr-FR')} √† ${now.toLocaleTimeString('fr-FR')}
            </div>
            <div class="info-item">
                <strong>V√©hicule</strong>
                ${mission?.vehicle_brand || 'BMW'} ${mission?.vehicle_model || 'S√©rie 3'}
            </div>
            <div class="info-item">
                <strong>Client</strong>
                ${mission?.client_name || 'Escuder Sylvain'}
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìã √âtat de la Mission</h2>
        <div class="checklist">
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>EDL D√©part valid√©</span>
            </div>
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>Photos de d√©part (10/10)</span>
            </div>
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>Checklist s√©curit√© compl√®te</span>
            </div>
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>Photos d'arriv√©e (3/3)</span>
            </div>
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>Signature client</span>
            </div>
            <div class="checklist-item">
                <span class="check">‚úÖ</span>
                <span>Mission finalis√©e</span>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>üì∏ Documentation Photo</h2>
        <div class="photo-section">
            <strong>Photos de d√©part:</strong>
            Compteur, Face avant, Face arri√®re, Lat√©raux (4), Moteur, Int√©rieur, Carnet d'entretien
        </div>
        <div class="photo-section">
            <strong>Photos d'arriv√©e:</strong>
            Compteur final, √âtat g√©n√©ral final, Remise des cl√©s
        </div>
    </div>
    
    <div class="section">
        <h2>üìù Observations</h2>
        <p><strong>D√©part:</strong> ${document.getElementById('departureObservations')?.value || 'Aucune observation particuli√®re'}</p>
        <p><strong>Arriv√©e:</strong> ${document.getElementById('arrivalObservations')?.value || 'V√©hicule livr√© en bon √©tat'}</p>
    </div>
    
    <div class="footer">
        <p>Rapport g√©n√©r√© automatiquement par FiableAuto v3.0</p>
        <p>Ce document certifie la bonne ex√©cution de la mission de transport</p>
    </div>
</body>
</html>`;
    }
    
    // FONCTIONS UTILITAIRES
    function updateCounters() {
        window.fiableAutoState.departurePhotos = document.querySelectorAll('#departurePhotos .uploaded').length;
        window.fiableAutoState.arrivalPhotos = document.querySelectorAll('#arrivalPhotos .uploaded').length;
        updateButtons();
    }
    
    function updateButtons() {
        const validateBtn = document.getElementById('validateDeparture');
        if (validateBtn && !window.fiableAutoState.departureValidated) {
            const canValidate = window.fiableAutoState.checkboxes >= 5 && window.fiableAutoState.departurePhotos >= 10;
            validateBtn.disabled = !canValidate;
            validateBtn.style.opacity = canValidate ? '1' : '0.6';
            
            if (canValidate) {
                validateBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                validateBtn.innerHTML = '<i class="fas fa-check-circle"></i> VALIDER D√âPART';
            }
        }
        
        const finalizeBtn = document.getElementById('finalizeMission');
        if (finalizeBtn && !window.fiableAutoState.missionCompleted) {
            const canFinalize = window.fiableAutoState.departureValidated && window.fiableAutoState.arrivalPhotos >= 3;
            finalizeBtn.disabled = !canFinalize;
            finalizeBtn.style.opacity = canFinalize ? '1' : '0.6';
            
            if (canFinalize) {
                finalizeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                finalizeBtn.innerHTML = '<i class="fas fa-trophy"></i> FINALISER MISSION';
            }
        }
    }
    
    function getChecklistData() {
        const data = {};
        document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
            data[checkbox.name] = checkbox.checked;
        });
        return data;
    }
    
    function getSignatureData() {
        const canvas = document.getElementById('signatureCanvas');
        if (!canvas) return null;
        
        const ctx = canvas.getContext('2d');
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < imgData.data.length; i += 4) {
            if (imgData.data[i + 3] !== 0) {
                return canvas.toDataURL('image/png');
            }
        }
        return null;
    }
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        requestAnimationFrame(() => toast.style.transform = 'translateX(0)');
        
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 4000);
    }
    
    function showCompletionScreen() {
        const missionDetails = document.getElementById('missionDetails');
        if (missionDetails) missionDetails.style.display = 'none';
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
        
        const mission = window.fiableAutoState.currentMission;
        const missionInfo = mission ? `Mission ${mission.mission_code} finalis√©e` : 'Mission finalis√©e';
        
        overlay.innerHTML = `
            <div style="background:white;border-radius:20px;padding:3rem 2rem;text-align:center;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);border:3px solid #10b981;">
                <div style="font-size:5rem;color:#10b981;margin-bottom:1.5rem;">üéâ</div>
                <h2 style="color:#10b981;font-size:2.5rem;margin-bottom:1rem;font-weight:700;">Mission Finalis√©e!</h2>
                <p style="color:#64748b;margin-bottom:1rem;font-size:1.2rem;">${missionInfo}</p>
                <p style="color:#059669;font-weight:600;margin-bottom:1rem;">‚úÖ Sauvegard√©e avec statut: completed</p>
                <p style="font-size:1rem;color:#94a3b8;margin-bottom:2rem;">Disponible dans <strong>Gestionnaire > Missions termin√©es</strong></p>
                
                <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
                    <button onclick="switchToGestionnaire()" style="background:linear-gradient(135deg,#3b82f6,#1e40af);color:white;border:none;padding:1rem 2rem;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;">
                        üë®‚Äçüíº Voir Gestionnaire
                    </button>
                    <button onclick="location.reload()" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;padding:1rem 2rem;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;">
                        üîÑ Nouvelle Mission
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        window.switchToGestionnaire = function() {
            overlay.remove();
            const gestionnaireTab = document.querySelector('[data-section="gestionnaire"]');
            if (gestionnaireTab) {
                gestionnaireTab.click();
                setTimeout(() => {
                    const missionsList = document.getElementById('missionsList');
                    if (missionsList) missionsList.scrollIntoView({ behavior: 'smooth' });
                }, 500);
            }
        };
    }
    
})();

// Marqueur de fin
if ('performance' in window && 'mark' in performance) {
    performance.mark('fiableauto-patch-final-v3-loaded');
}
</script>

</body>
</html>



