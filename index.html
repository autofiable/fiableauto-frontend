<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FiableAuto - Solution professionnelle d'inspection v√©hicules</title>
  <meta name="description" content="Application professionnelle d'inspection et de convoyage de v√©hicules partout en France" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a2a5a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="FiableAuto" />

  <!-- ============ Styles additionnels sp√©cifiques √† cette page ============ -->
  <style>
    :root {
      --primary-blue:#0a2a5a; /* bleu fonc√© FiableAuto */
      --primary-blue-2:#007bff; /* accent */
      --accent-orange:#ff7a00; /* volant orange */
      --success:#28a745; --warning:#ffc107; --danger:#dc3545;
      --bg:#ffffff; --bg-soft:#f7f8fc; --text:#1f2937; --muted:#6b7280; --stroke:#e5e7eb;
    }
    [data-theme="dark"]{--bg:#0b1220; --bg-soft:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --stroke:#1f2937;}

    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* Header */
    .header-modern{position:sticky;top:0;z-index:30;background:var(--bg);border-bottom:1px solid var(--stroke)}
    .app-logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--primary-blue);display:grid;place-items:center;color:#fff}
    .logo-text h1{margin:0;font-size:20px;letter-spacing:.2px}
    .logo-text .logo-accent{color:var(--accent-orange)}
    .tagline{font-size:12px;color:var(--muted)}

    .nav-pills{display:flex;gap:8px;margin-top:10px}
    .nav-pill{border:1px solid var(--stroke);background:var(--bg-soft);color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
    .nav-pill.active{background:var(--primary-blue);color:#fff;border-color:var(--primary-blue)}

    /* Sections */
    .section{display:none;margin-top:16px}
    .section.active{display:block}
    .section-header h2{margin:.2rem 0}
    .section-header p{margin:0;color:var(--muted)}

    /* Cards / blocks */
    .card{background:var(--bg);border:1px solid var(--stroke);border-radius:12px;padding:16px}
    .section-title{display:flex;align-items:center;gap:8px;margin:0 0 12px 0;color:var(--primary-blue)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .input{width:100%;padding:12px 14px;border:1.5px solid var(--stroke);border-radius:10px;background:#fff}
    .input:focus{outline:none;border-color:var(--primary-blue-2);box-shadow:0 0 0 3px rgba(0,123,255,.1)}
    .select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:34px}

    .btn{display:inline-flex;align-items:center;gap:8px;border:none;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--primary-blue);color:#fff}
    .btn-primary:hover{filter:brightness(.95)}
    .btn-secondary{background:var(--bg-soft);color:var(--text);border:1px solid var(--stroke)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}

    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .stat{background:var(--bg-soft);border:1px solid var(--stroke);border-radius:12px;padding:12px;text-align:center}
    .stat h3{margin:0;font-size:22px}
    .stat p{margin:6px 0 0 0;color:var(--muted)}

    /* Progress */
    .progress{margin:20px 0;padding:14px;background:var(--bg-soft);border:1px solid var(--stroke);border-radius:12px}
    .steps{display:flex;justify-content:space-between;position:relative;margin-bottom:8px}
    .steps-line{position:absolute;top:20px;left:0;height:4px;background:var(--primary-blue-2);border-radius:2px;width:0;transition:width .4s ease}
    .step{width:40px;height:40px;border-radius:999px;background:#fff;border:4px solid var(--stroke);display:grid;place-items:center;font-weight:700;z-index:2}
    .step.active{background:var(--primary-blue-2);border-color:var(--primary-blue-2);color:#fff}
    .step.done{background:var(--success);border-color:var(--success);color:#fff}

    /* Photo cards */
    .photos{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .photo-card{border:2px dashed var(--stroke);border-radius:12px;padding:14px;text-align:center;background:#fff}
    .photo-card.uploaded{border-color:var(--success);background:#f4fff6}
    .preview{display:none;max-width:100%;border-radius:8px;margin-top:10px}

    /* Modals / overlays */
    .qr-scanner{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:100}
    .qr-box{background:#fff;border-radius:12px;padding:16px;max-width:420px;width:92%}
    .loading{position:fixed;inset:0;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;z-index:90}
    .spinner{border:3px solid #e5e7eb;border-top:3px solid var(--primary-blue-2);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Toaster */
    .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);padding:12px 16px;border-radius:10px;color:#fff;opacity:0;transition:.3s;z-index:120}
    .toast.show{opacity:1;transform:translate(-50%,8px)}
    .toast.info{background:var(--primary-blue-2)}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--danger)}

    /* Footer legal */
    footer{margin:48px 0 24px 0;color:var(--muted);font-size:12px;text-align:center}
    footer a{color:inherit}

    @media (max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Theme toggle -->
  <button class="btn btn-primary" id="themeToggle" style="position:fixed;right:16px;top:16px;z-index:40;border-radius:999px;width:46px;height:46px;display:grid;place-items:center"><i id="themeIcon" class="fas fa-moon"></i></button>

  <!-- QR Scanner -->
  <div id="qrModal" class="qr-scanner" aria-hidden="true">
    <div class="qr-box">
      <h3 style="margin-top:0">Scanner un QR code</h3>
      <div id="qr-reader" style="width:100%;height:220px;background:#f0f0f0;border-radius:8px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-secondary" type="button" onclick="closeQr()"><i class="fas fa-times"></i> Fermer</button>
      </div>
      <!-- TODO: int√©grer html5-qrcode c√¥t√© JS -->
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading" class="loading"><div class="spinner" aria-label="Chargement..."></div></div>

  <!-- Toast -->
  <div id="toast" class="toast info"></div>

  <!-- Header -->
  <header class="header-modern">
    <div class="container">
      <div class="app-logo">
        <div class="logo-icon"><i class="fas fa-car"></i></div>
        <div class="logo-text">
          <h1>Fiable<span class="logo-accent">Auto</span></h1>
          <div class="tagline">Solution Professionnelle</div>
        </div>
      </div>
      <nav class="nav-pills" role="tablist" aria-label="Navigation des espaces">
        <button class="nav-pill active" data-section="gestionnaire" aria-selected="true">üè¢ Gestionnaire</button>
        <button class="nav-pill" data-section="prestataire" aria-selected="false">üîß Prestataire</button>
        <button class="nav-pill" data-section="client" aria-selected="false">üë§ Client</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- ===================== GESTIONNAIRE ===================== -->
    <section id="gestionnaire" class="section active" aria-label="Espace Gestionnaire">
      <div class="section-header">
        <h2><i class="fas fa-building"></i> Interface Gestionnaire</h2>
        <p>Cr√©ez et g√©rez vos missions d'inspection en quelques clics</p>
      </div>

      <div class="stat-grid">
        <div class="stat"><h3 id="totalMissions">0</h3><p>Missions cr√©√©es</p></div>
        <div class="stat"><h3 id="pendingMissions">0</h3><p>En attente</p></div>
        <div class="stat"><h3 id="progressMissions">0</h3><p>En cours</p></div>
        <div class="stat"><h3 id="completedMissions">0</h3><p>Termin√©es</p></div>
      </div>

      <!-- Cr√©ation mission -->
      <form id="missionForm" class="card" novalidate>
        <h3 class="section-title"><i class="fas fa-user"></i> Informations Client</h3>
        <div class="grid grid-2">
          <div><label>Soci√©t√© / Entreprise<input class="input" id="clientCompany" name="clientCompany" placeholder="Ex: Peugeot Manosque" /></label></div>
          <div><label>Nom complet *<input required class="input" id="clientName" name="clientName" placeholder="Ex: Dominique Moreaux" /></label></div>
          <div><label>Email *<input required type="email" class="input" id="clientEmail" name="clientEmail" placeholder="dominique.moreaux@groupechopard.com" /></label></div>
          <div><label>T√©l√©phone<input type="tel" class="input" id="clientPhone" name="clientPhone" placeholder="+33 6 XX XX XX XX" /></label></div>
        </div>

        <h3 class="section-title" style="margin-top:14px"><i class="fas fa-car"></i> Informations V√©hicule</h3>
        <div class="grid grid-3">
          <div><label>Immatriculation *<input required class="input" id="licensePlate" name="licensePlate" placeholder="FY-214-XE" style="text-transform:uppercase" /></label></div>
          <div><label>Marque *<input required class="input" id="vehicleBrand" name="vehicleBrand" placeholder="Citro√´n" /></label></div>
          <div><label>Mod√®le *<input required class="input" id="vehicleModel" name="vehicleModel" placeholder="Jumper" /></label></div>
          <div><label>Ann√©e<input type="number" min="1990" max="2030" class="input" id="vehicleYear" name="vehicleYear" placeholder="2023" /></label></div>
          <div><label>Kilom√©trage (km)<input type="number" class="input" id="mileage" name="mileage" placeholder="45000" /></label></div>
          <div>
            <label>Niveau de carburant
              <select id="fuelLevel" name="fuelLevel" class="input select">
                <option value="">S√©lectionner</option>
                <option value="empty">R√©servoir vide</option>
                <option value="1/4">1/4 plein</option>
                <option value="1/2">1/2 plein</option>
                <option value="3/4">3/4 plein</option>
                <option value="full">Plein</option>
              </select>
            </label>
          </div>
        </div>

        <h3 class="section-title" style="margin-top:14px"><i class="fas fa-route"></i> D√©tails Mission</h3>
        <div class="grid grid-2">
          <div>
            <label>Lieu de prise en charge *
              <div style="position:relative">
                <input required class="input" id="pickupLocation" name="pickupLocation" placeholder="Adresse compl√®te" />
                <button class="btn btn-primary" type="button" style="position:absolute;right:6px;top:6px;padding:8px;border-radius:8px" onclick="getCurrentLocation('pickupLocation')"><i class="fas fa-location-arrow"></i></button>
              </div>
            </label>
          </div>
          <div>
            <label>Lieu de livraison *
              <div style="position:relative">
                <input required class="input" id="deliveryLocation" name="deliveryLocation" placeholder="Adresse compl√®te" />
                <button class="btn btn-primary" type="button" style="position:absolute;right:6px;top:6px;padding:8px;border-radius:8px" onclick="getCurrentLocation('deliveryLocation')"><i class="fas fa-location-arrow"></i></button>
              </div>
            </label>
          </div>
          <div><label>Date de prise en charge *<input required type="datetime-local" class="input" id="pickupDate" name="pickupDate" /></label></div>
          <div><label>Date de livraison pr√©vue<input type="datetime-local" class="input" id="deliveryDate" name="deliveryDate" /></label></div>
          <div>
            <label>Niveau d'urgence
              <select id="urgency" name="urgency" class="input select">
                <option value="normal">Normal</option>
                <option value="urgent">Urgent</option>
                <option value="critical">Critique</option>
              </select>
            </label>
          </div>
          <div>
            <label>Type de mission
              <select id="missionType" name="missionType" class="input select">
                <option value="inspection">Inspection simple</option>
                <option value="convoyage">Convoyage</option>
                <option value="both">Inspection + Convoyage</option>
              </select>
            </label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width:100%;margin-top:12px"><i class="fas fa-rocket"></i> Cr√©er la mission</button>
      </form>

      <!-- Liste & Archives -->
      <div class="card" style="margin-top:16px">
        <h3 class="section-title"><i class="fas fa-archive"></i> Toutes les missions</h3>
        <div id="missionsList"><p style="color:var(--muted)">Aucune mission cr√©√©e pour le moment.</p></div>
        <!-- Les boutons de t√©l√©chargement seront inject√©s c√¥t√© JS par mission :
             <button class='btn btn-success' data-action='download-pdf' data-id='...'><i class='fas fa-file-pdf'></i> T√©l√©charger PDF</button>
             <button class='btn btn-secondary' data-action='download-zip' data-id='...'><i class='fas fa-file-archive'></i> Photos (.zip)</button>
        -->
      </div>
    </section>

    <!-- ===================== PRESTATAIRE ===================== -->
    <section id="prestataire" class="section" aria-label="Espace Prestataire">
      <div class="section-header">
        <h2><i class="fas fa-tools"></i> Interface Prestataire</h2>
        <p>Acc√©dez √† votre mission et compl√©tez l'inspection</p>
      </div>

      <!-- Acc√®s mission -->
      <div class="card">
        <h3 class="section-title"><i class="fas fa-key"></i> Acc√©der √† une mission</h3>
        <form id="accessForm">
          <div class="grid">
            <label>Code de mission<input class="input" id="missionCode" name="missionCode" placeholder="Ex: FA-20250823-001" required /></label>
          </div>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn btn-primary" type="submit" style="flex:1"><i class="fas fa-search"></i> Acc√©der</button>
            <button class="btn btn-secondary" type="button" onclick="openQr()"><i class="fas fa-qrcode"></i> Scanner QR</button>
          </div>
        </form>
      </div>

      <!-- D√©tails mission -->
      <div id="missionDetails" class="card" style="display:none">
        <h3 class="section-title"><i class="fas fa-car"></i> Mission en cours</h3>
        <div id="missionInfo"></div>

        <!-- Progression Prestataire : Acc√®s -> EDL D√©part -> Photos D√©part -> EDL Arriv√©e -> Signature & Finalisation -->
        <div class="progress">
          <div class="steps">
            <div id="pLine" class="steps-line"></div>
            <div id="pStep1" class="step active">1</div>
            <div id="pStep2" class="step">2</div>
            <div id="pStep3" class="step">3</div>
            <div id="pStep4" class="step">4</div>
            <div id="pStep5" class="step">5</div>
          </div>
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:12px">
            <span>Acc√®s</span><span>EDL D√©part</span><span>Photos D√©part</span><span>EDL Arriv√©e</span><span>Signature & Fin</span>
          </div>
        </div>

        <!-- ========== EDL D√âPART ========== -->
        <section id="edlDepart" style="margin:14px 0">
          <h4 style="margin:0 0 10px 0"><i class="fas fa-clipboard-check"></i> √âtat des lieux ‚Äì D√©part</h4>
          <div class="grid">
            <div class="card" style="padding:12px">
              <strong>Checklist d√©part</strong>
              <div class="grid" style="margin-top:8px">
                <label>Nombre de cl√©(s)
                  <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                    <button type="button" class="btn btn-secondary" onclick="adjustKeys(-1)" style="padding:6px 10px">-</button>
                    <span id="keyCount" style="min-width:28px;text-align:center;font-weight:700">0</span>
                    <button type="button" class="btn btn-primary" onclick="adjustKeys(1)" style="padding:6px 10px">+</button>
                  </div>
                </label>
                <label>Papiers du v√©hicule
                  <select class="input select" name="vehiclePapers_depart">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
                <label>GPS
                  <select class="input select" name="gps_depart">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
                <label>Kit s√©curit√© (Gilet + Triangle)
                  <select class="input select" name="safety_depart">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
                <label>Roue secours / Kit
                  <select class="input select" name="spare_depart">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
              </div>
            </div>
          </div>

          <!-- Photos d√©part -->
          <div style="margin-top:12px">
            <strong><i class="fas fa-camera"></i> Photos obligatoires ‚Äì D√©part</strong>
            <div class="photos" id="photosDepart">
              <!-- Cartes photos (compteur, faces, lat√©raux, moteur, int√©rieur, carnet) -->
              <!-- Les m√™mes types que l'existant; dupliqu√©s pour d√©part avec suffixe _depart -->
              <div class="photo-card" data-type="compteur_depart">
                <h5>Compteur (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-compteur-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-compteur-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="face_avant_depart">
                <h5>Face avant (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-face-avant-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-face-avant-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="face_arriere_depart">
                <h5>Face arri√®re (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-face-arriere-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-face-arriere-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="lateral_g_depart">
                <h5>Lat√©ral gauche (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-lateral-g-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-lateral-g-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="lateral_d_depart">
                <h5>Lat√©ral droit (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-lateral-d-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-lateral-d-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="moteur_depart">
                <h5>Moteur (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-moteur-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-moteur-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="interieur_depart">
                <h5>Int√©rieur (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-interieur-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-interieur-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="carnet_depart">
                <h5>Carnet (d√©part)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-carnet-depart" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-carnet-depart').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
            </div>
          </div>
        </section>

        <!-- ========== EDL ARRIV√âE (+ Signature) ========== -->
        <section id="edlArrivee" style="margin:14px 0">
          <h4 style="margin:0 0 10px 0"><i class="fas fa-clipboard-list"></i> √âtat des lieux ‚Äì Arriv√©e</h4>
          <div class="grid">
            <div class="card" style="padding:12px">
              <strong>Checklist arriv√©e</strong>
              <div class="grid" style="margin-top:8px">
                <label>Papiers du v√©hicule
                  <select class="input select" name="vehiclePapers_arrivee">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
                <label>Kit s√©curit√© (Gilet + Triangle)
                  <select class="input select" name="safety_arrivee">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
                <label>Roue secours / Kit
                  <select class="input select" name="spare_arrivee">
                    <option value="">S√©lectionner</option><option value="yes">Oui</option><option value="no">Non</option>
                  </select>
                </label>
              </div>
            </div>
          </div>

          <!-- Photos arriv√©e -->
          <div style="margin-top:12px">
            <strong><i class="fas fa-camera"></i> Photos obligatoires ‚Äì Arriv√©e</strong>
            <div class="photos" id="photosArrivee">
              <!-- m√™mes jeux de cartes avec suffixe _arrivee -->
              <div class="photo-card" data-type="compteur_arrivee">
                <h5>Compteur (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-compteur-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-compteur-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="face_avant_arrivee">
                <h5>Face avant (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-face-avant-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-face-avant-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="face_arriere_arrivee">
                <h5>Face arri√®re (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-face-arriere-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-face-arriere-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="lateral_g_arrivee">
                <h5>Lat√©ral gauche (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-lateral-g-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-lateral-g-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="lateral_d_arrivee">
                <h5>Lat√©ral droit (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-lateral-d-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-lateral-d-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="moteur_arrivee">
                <h5>Moteur (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-moteur-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-moteur-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="interieur_arrivee">
                <h5>Int√©rieur (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-interieur-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-interieur-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
              <div class="photo-card" data-type="carnet_arrivee">
                <h5>Carnet (arriv√©e)</h5>
                <input type="file" accept="image/*" capture="environment" id="photo-carnet-arrivee" style="display:none" />
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photo-carnet-arrivee').click()"><i class="fas fa-camera"></i> Prendre</button>
                <img class="preview" />
              </div>
            </div>
          </div>

          <!-- Observations -->
          <div style="margin-top:12px">
            <strong><i class="fas fa-comment"></i> Observations</strong>
            <textarea id="observations" rows="5" class="input" placeholder="Remarques, dommages, etc."></textarea>
          </div>

          <!-- Signature (UNIQUEMENT √† l'arriv√©e) -->
          <div style="margin-top:12px">
            <strong><i class="fas fa-signature"></i> Signature du client (arriv√©e)</strong>
            <div style="text-align:center;margin:10px 0"><canvas id="signatureCanvas" width="600" height="220" style="max-width:100%;border:1.5px solid var(--stroke);border-radius:10px;background:#fff"></canvas></div>
            <div style="display:flex;gap:10px;justify-content:center">
              <button type="button" class="btn btn-secondary" id="clearSignature"><i class="fas fa-eraser"></i> Effacer</button>
              <button type="button" class="btn btn-success" id="finalizeInspection"><i class="fas fa-check"></i> Signer et terminer</button>
            </div>
          </div>
        </section>

        <!-- √âcran de fin + redirection accueil prestataire -->
        <div id="finishScreen" class="card" style="margin-top:12px;display:none;text-align:center">
          <i class="fas fa-circle-check" style="font-size:42px;color:var(--success)"></i>
          <h3>Mission finalis√©e</h3>
          <p>Le rapport sera g√©n√©r√© automatiquement. Vous allez √™tre redirig√© vers l'accueil prestataire.</p>
          <button class="btn btn-primary" type="button" id="goPrestataireHome"><i class="fas fa-home"></i> Retour √† l'accueil prestataire</button>
        </div>
      </div>
    </section>

    <!-- ===================== CLIENT ===================== -->
    <section id="client" class="section" aria-label="Espace Client">
      <div class="section-header">
        <h2><i class="fas fa-user"></i> Interface Client</h2>
        <p>Suivez l'avancement de votre inspection en temps r√©el</p>
      </div>

      <div class="card">
        <h3 class="section-title"><i class="fas fa-search"></i> Suivre ma mission</h3>
        <form id="trackingForm">
          <label>Code de suivi<input class="input" id="trackingCode" name="trackingCode" placeholder="Ex: FA-20250823-001" required /></label>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn btn-primary" type="submit" style="flex:1"><i class="fas fa-search"></i> Suivre</button>
            <button class="btn btn-secondary" type="button" onclick="openQr()"><i class="fas fa-qrcode"></i> Scanner QR</button>
          </div>
        </form>
      </div>

      <div id="trackingResult" class="card" style="display:none;margin-top:12px">
        <h3 class="section-title"><i class="fas fa-info-circle"></i> √âtat de votre mission</h3>
        <div id="trackingInfo"></div>

        <div class="progress">
          <div class="steps">
            <div id="cLine" class="steps-line"></div>
            <div class="step done">‚úì</div>
            <div id="cStep2" class="step">2</div>
            <div id="cStep3" class="step">3</div>
            <div id="cStep4" class="step">4</div>
            <div id="cStep5" class="step">5</div>
          </div>
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:12px"><span>Cr√©√©e</span><span>Assign√©e</span><span>En cours</span><span>Photos</span><span>Termin√©e</span></div>
        </div>

        <div id="downloadSection" style="display:none;text-align:center;margin-top:10px">
          <h4><i class="fas fa-file-pdf"></i> Rapport disponible</h4>
          <p style="color:var(--muted)">Votre inspection est termin√©e. T√©l√©chargez votre rapport complet.</p>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-success" id="downloadReport"><i class="fas fa-download"></i> T√©l√©charger PDF</button>
            <button class="btn btn-primary" type="button" id="emailReport"><i class="fas fa-envelope"></i> Envoyer par email</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>¬© <span id="year"></span> FiableAuto ‚Äì Tous droits r√©serv√©s ¬∑ <a href="#" id="link-mentions">Mentions l√©gales</a> ¬∑ <a href="#" id="link-cgv">CGV</a> ¬∑ <a href="#" id="link-privacy">Confidentialit√©</a></p>
  </footer>

  <!-- ============ Scripts ============ -->
  <script>
    // --- Utils UI ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const toastEl = $('#toast');
    function toast(msg, type='info'){toastEl.textContent = msg; toastEl.className = `toast ${type} show`; setTimeout(()=> toastEl.classList.remove('show'), 3500)}
    const loading = { show:()=> $('#loading').style.display='flex', hide:()=> $('#loading').style.display='none' };

    // Theme
    const themeBtn = $('#themeToggle'); const themeIcon = $('#themeIcon');
    function setTheme(t){document.body.dataset.theme=t; localStorage.setItem('theme', t); themeIcon.className = t==='dark'? 'fas fa-sun':'fas fa-moon'}
    themeBtn.addEventListener('click', ()=> setTheme((localStorage.getItem('theme')||'light')==='light'?'dark':'light'));

    // Nav
    $$('.nav-pill').forEach(btn=> btn.addEventListener('click', ()=>{
      $$('.nav-pill').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      $$('.section').forEach(s=> s.classList.remove('active'));
      const id = btn.dataset.section; $('#'+id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }));

    // QR
    function openQr(){ $('#qrModal').style.display='flex'; toast('Scanner QR (√† int√©grer html5-qrcode)', 'info') }
    function closeQr(){ $('#qrModal').style.display='none' }
    window.openQr = openQr; window.closeQr = closeQr;

    // Geoloc
    window.getCurrentLocation = function(inputId){
      if(!navigator.geolocation){return toast('G√©olocalisation non disponible', 'error')}
      navigator.geolocation.getCurrentPosition(pos=>{
        const v = `Lat: ${pos.coords.latitude.toFixed(6)}, Lng: ${pos.coords.longitude.toFixed(6)}`;
        $('#'+inputId).value = v;
      }, err=> toast('Erreur g√©olocalisation: '+err.message, 'error'))
    }

    // Keys counter (d√©part)
    let keyCount = 0; window.adjustKeys = function(n){ keyCount = Math.max(0, keyCount + n); const el = $('#keyCount'); if(el) el.textContent = keyCount }

    // Signature (arriv√©e uniquement)
    const sig = { drawing:false, points:[], canvas:null, ctx:null };
    function initSignature(){
      sig.canvas = $('#signatureCanvas'); if(!sig.canvas) return; sig.ctx = sig.canvas.getContext('2d');
      const c = sig.canvas; const getPos = e=>{const r=c.getBoundingClientRect(); const t=e.touches? e.touches[0] : e; return {x:(t.clientX-r.left)*c.width/r.width, y:(t.clientY-r.top)*c.height/r.height}};
      const start = e=>{sig.drawing=true; sig.points.push([]); sig.points.at(-1).push(getPos(e));}
      const move = e=>{if(!sig.drawing) return; const p=getPos(e); const s=sig.points.at(-1); s.push(p); const ctx=sig.ctx; const l=s.length; ctx.lineWidth=2; ctx.lineCap='round'; if(l>1){ctx.beginPath(); ctx.moveTo(s[l-2].x,s[l-2].y); ctx.lineTo(p.x,p.y); ctx.stroke()}}
      const end = ()=> sig.drawing=false;
      c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
      c.addEventListener('touchstart', start, {passive:true}); c.addEventListener('touchmove', move, {passive:true}); c.addEventListener('touchend', end);
      $('#clearSignature')?.addEventListener('click', ()=>{sig.ctx.clearRect(0,0,c.width,c.height); sig.points=[]})
    }

    // Progress helpers
    function setPrestataireProgress(step){
      const steps=[ '#pStep1','#pStep2','#pStep3','#pStep4','#pStep5' ].map(s=> $(s));
      steps.forEach((el,i)=>{ el.classList.remove('active','done'); if(i<step-1) el.classList.add('done'); if(i===step-1) el.classList.add('active') });
      $('#pLine').style.width = ((step-1)/4*100)+'%';
    }

    // Acc√®s mission (mock front pour l'instant)
    $('#accessForm')?.addEventListener('submit', e=>{ e.preventDefault(); const code=$('#missionCode').value.trim(); if(!code) return toast('Code requis','error');
      $('#missionDetails').style.display='block'; setPrestataireProgress(2); $('#missionInfo').innerHTML = `<div class="card" style="background:var(--bg-soft)"><strong>Mission:</strong> ${code}</div>`; window.scrollTo({top: $('#missionDetails').offsetTop-10, behavior:'smooth'});
    })

    // Finalisation (signature + redirection accueil prestataire)
    $('#finalizeInspection')?.addEventListener('click', ()=>{
      // TODO: validations: photos + signature pr√©sentes
      $('#finishScreen').style.display='block'; setPrestataireProgress(5);
      toast('Mission finalis√©e. G√©n√©ration du rapport en arri√®re-plan.', 'success');
      // Redirection automatique apr√®s 6 secondes
      const goHome = ()=>{ $$('.nav-pill').forEach(b=> b.classList.remove('active')); $$('.section').forEach(s=> s.classList.remove('active')); $('[data-section="prestataire"]').classList.add('active'); $('#prestataire').classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); $('#missionDetails').style.display='none'; $('#finishScreen').style.display='none'};
      setTimeout(goHome, 6000); $('#goPrestataireHome').onclick = goHome;
    })

    // Tracking client (mock front)
    $('#trackingForm')?.addEventListener('submit', e=>{e.preventDefault(); $('#trackingResult').style.display='block'; $('#trackingInfo').innerHTML='<div class="card" style="background:var(--bg-soft)">Mission en cours...</div>'; $('#cLine').style.width='40%'; })

    // Email report mock
    $('#emailReport')?.addEventListener('click', ()=>{ toast('Envoi email : √† brancher √† l\'API', 'info') })
    $('#downloadReport')?.addEventListener('click', ()=>{ toast('T√©l√©chargement PDF : √† brancher √† l\'API', 'info') })

    // Cr√©ation mission (mock front)
    $('#missionForm')?.addEventListener('submit', e=>{e.preventDefault(); toast('Mission cr√©√©e (mock). √Ä brancher DB/API.', 'success')})

    // Initialisation
    (function init(){ setTheme(localStorage.getItem('theme')||'light'); $('#year').textContent=new Date().getFullYear(); initSignature(); })();
  </script>
  <script src="script.js"></script>
</body>
</html>
