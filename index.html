<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiableAuto ‚Äì Web App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body data-theme="light">
  <header>
    <h1>üöó FiableAuto</h1>
  </header>

  <!-- Navigation -->
  <nav class="nav">
    <button class="nav-pill active" data-section="gestionnaire"><i class="fas fa-user-tie"></i> Gestionnaire</button>
    <button class="nav-pill" data-section="prestataire"><i class="fas fa-user-cog"></i> Prestataire</button>
    <button class="nav-pill" data-section="client"><i class="fas fa-user"></i> Client</button>
  </nav>

  <!-- GESTIONNAIRE -->
  <section id="gestionnaire" class="section active">
    <!-- Stats Dashboard -->
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalMissions">0</h3>
          <p>Missions cr√©√©es</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingMissions">0</h3>
          <p>En attente</p>
        </div>
        <div class="stat-card">
          <h3 id="progressMissions">0</h3>
          <p>En cours</p>
        </div>
        <div class="stat-card">
          <h3 id="completedMissions">0</h3>
          <p>Termin√©es</p>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>Cr√©er une mission</h2>
      <form id="missionForm" class="enhanced-form">
        <div class="form-grid">
          <input type="text" name="vehicleBrand" placeholder="Marque" required>
          <input type="text" name="vehicleModel" placeholder="Mod√®le" required>
          <input type="number" name="vehicleYear" placeholder="Ann√©e">
          <input type="text" name="licensePlate" placeholder="Immatriculation">
          <input type="number" name="mileage" placeholder="Kilom√©trage">
          <input type="text" name="pickupLocation" placeholder="Lieu prise en charge" required>
          <input type="text" name="deliveryLocation" placeholder="Lieu livraison" required>
          <input type="date" name="pickupDate">
          <input type="date" name="deliveryDate">
          <input type="text" name="clientName" placeholder="Nom client" required>
          <input type="email" name="clientEmail" placeholder="Email client" required>
          <input type="text" name="clientPhone" placeholder="T√©l√©phone client">
        </div>
        <button type="submit" class="btn-enhanced btn-primary">Cr√©er mission</button>
      </form>

      <h3>Missions archiv√©es</h3>
      <div id="missionsList"></div>
    </div>
  </section>

  <!-- PRESTATAIRE -->
  <section id="prestataire" class="section">
    <div class="container">
      <h2>Acc√©der √† une mission</h2>
      <form id="accessForm" class="enhanced-form">
        <input type="text" id="missionCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Acc√©der</button>
      </form>

      <div id="missionDetails" style="display:none; margin-top:20px;">
        <div id="missionInfo"></div>

        <!-- Phase D√©part -->
        <div id="departurePhase" class="mission-phase">
          <h3 class="phase-title"><i class="fas fa-play-circle"></i> Phase D√©part</h3>
          
          <!-- Checklist -->
          <div id="checklist" class="enhanced-form-section">
            <div class="section-title"><i class="fas fa-list-check"></i> Checklist</div>
            <label><input type="checkbox" name="vehiclePapers" value="ok"> Papiers v√©hicule OK</label>
            <label><input type="checkbox" name="gps" value="ok"> GPS fonctionnel</label>
            <label><input type="checkbox" name="sdCard" value="ok"> Carte SD pr√©sente</label>
            <label><input type="checkbox" name="safetyKit" value="ok"> Kit s√©curit√© complet</label>
            <label><input type="checkbox" name="spareWheel" value="ok"> Roue de secours</label>
          </div>

          <!-- Photos de d√©part AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos de d√©part</h4>
            <div class="photo-grid" id="departurePhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur</label>
                </div>
                <input type="file" data-photo="compteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car photo-icon"></i>
                  <label>Face avant</label>
                </div>
                <input type="file" data-photo="face-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-rear photo-icon"></i>
                  <label>Face arri√®re</label>
                </div>
                <input type="file" data-photo="face-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral gauche avant</label>
                </div>
                <input type="file" data-photo="lateral-gauche-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral gauche arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-gauche-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral droit avant</label>
                </div>
                <input type="file" data-photo="lateral-droit-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral droit arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-droit-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-cog photo-icon"></i>
                  <label>Moteur</label>
                </div>
                <input type="file" data-photo="moteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-chair photo-icon"></i>
                  <label>Int√©rieur</label>
                </div>
                <input type="file" data-photo="interieur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-book photo-icon"></i>
                  <label>Carnet d'entretien</label>
                </div>
                <input type="file" data-photo="carnet" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations de d√©part -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations de d√©part</h4>
            <textarea id="departureObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule au d√©part..."></textarea>
          </div>

          <button type="button" id="validateDeparture" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check"></i> Valider D√©part
          </button>
        </div>

        <!-- Phase Arriv√©e -->
        <div id="arrivalPhase" class="mission-phase" style="display:none;">
          <h3 class="phase-title"><i class="fas fa-flag-checkered"></i> Phase Arriv√©e</h3>
          
          <!-- Photos d'arriv√©e AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos d'arriv√©e</h4>
            <div class="photo-grid" id="arrivalPhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur final</label>
                </div>
                <input type="file" data-photo="compteur-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-crash photo-icon"></i>
                  <label>√âtat g√©n√©ral final</label>
                </div>
                <input type="file" data-photo="etat-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-key photo-icon"></i>
                  <label>Remise cl√©s</label>
                </div>
                <input type="file" data-photo="remise-cles" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations d'arriv√©e -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations d'arriv√©e</h4>
            <textarea id="arrivalObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule √† l'arriv√©e..."></textarea>
          </div>

          <!-- Signature client -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-signature"></i> Signature du client</h4>
            <div class="signature-section">
              <canvas id="signatureCanvas" width="500" height="200"></canvas>
              <div class="signature-controls">
                <button type="button" id="clearSignature" class="btn-enhanced btn-secondary">
                  <i class="fas fa-eraser"></i> Effacer
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="finalizeMission" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check-double"></i> Finaliser Mission
          </button>
        </div>

        <!-- √âcran de fin -->
        <div id="completionScreen" class="completion-screen" style="display:none;">
          <div class="completion-content">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>Mission Finalis√©e avec Succ√®s !</h3>
            <p>La mission a √©t√© compl√©t√©e et le rapport est disponible.</p>
            <button type="button" id="returnToHome" class="btn-enhanced btn-primary">
              <i class="fas fa-home"></i> Retour Accueil Prestataire
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENT -->
  <section id="client" class="section">
    <div class="container">
      <h2>Suivi de mission</h2>
      <form id="trackingForm" class="enhanced-form">
        <input type="text" id="trackingCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Suivre ma mission</button>
      </form>
      
      <div id="trackingResult" style="display:none;">
        <div id="trackingInfo"></div>
        
        <!-- Statut de progression -->
        <div id="progressTracker" class="progress-tracker">
          <div class="progress-step" data-step="created">
            <div class="step-icon"><i class="fas fa-plus"></i></div>
            <div class="step-label">Mission cr√©√©e</div>
          </div>
          <div class="progress-step" data-step="in-progress">
            <div class="step-icon"><i class="fas fa-road"></i></div>
            <div class="step-label">En cours</div>
          </div>
          <div class="progress-step" data-step="departure-validated">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div class="step-label">D√©part valid√©</div>
          </div>
          <div class="progress-step" data-step="completed">
            <div class="step-icon"><i class="fas fa-flag-checkered"></i></div>
            <div class="step-label">Termin√©e</div>
          </div>
        </div>

        <!-- Section rapport -->
        <div id="downloadSection" style="display:none;">
          <div class="report-section">
            <h4><i class="fas fa-file-pdf"></i> Rapport de mission</h4>
            <div class="report-actions">
              <button id="downloadReport" class="btn-enhanced btn-success">
                <i class="fas fa-download"></i> T√©l√©charger rapport PDF
              </button>
              <button id="emailReport" class="btn-enhanced btn-secondary">
                <i class="fas fa-envelope"></i> Envoyer par email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notifications et Loading -->
  <div id="notification" class="notification"></div>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
  </div>

  <script src="script.js"></script>

<!-- üîß PATCH DEBUG - INT√âGRATION APP PRINCIPALE -->

<script>
(function() {
    'use strict';
    
    console.log('üîß Patch Debug - Diagnostic complet...');
    
    // Attendre que l'app principale soit compl√®tement charg√©e
    setTimeout(function() {
        try {
            // ========== DIAGNOSTIC SYST√àME ==========
            console.log('üìä DIAGNOSTIC SYST√àME:');
            console.log('- window.app existe:', !!window.app);
            console.log('- currentMission:', window.app?.currentMission);
            console.log('- URL actuelle:', window.location.href);
            console.log('- Section active:', window.app?.currentSection);
            
            // ========== √âTAT GLOBAL ==========
            window.missionPatchState = {
                departureValidated: false,
                missionCompleted: false,
                departurePhotos: 0,
                arrivalPhotos: 0,
                checkboxes: 0,
                currentMission: null,
                uploadedFiles: {
                    departure: new Map(),
                    arrival: new Map()
                }
            };
            
            // ========== R√âCUP√âRATION MISSION ROBUSTE ==========
            function getCurrentMission() {
                // M√©thode 1: Via window.app
                if (window.app && window.app.currentMission) {
                    console.log('‚úÖ Mission r√©cup√©r√©e via window.app');
                    return window.app.currentMission;
                }
                
                // M√©thode 2: Via localStorage si disponible
                try {
                    const savedMission = localStorage.getItem('currentMission');
                    if (savedMission) {
                        console.log('‚úÖ Mission r√©cup√©r√©e via localStorage');
                        return JSON.parse(savedMission);
                    }
                } catch (e) {
                    console.warn('‚ùå Erreur localStorage:', e);
                }
                
                // M√©thode 3: Via le code mission dans le formulaire
                const missionCodeInput = document.getElementById('missionCode');
                if (missionCodeInput && missionCodeInput.value) {
                    console.log('‚úÖ Code mission trouv√© dans formulaire:', missionCodeInput.value);
                    return { mission_code: missionCodeInput.value, id: null };
                }
                
                console.warn('‚ùå Aucune mission active trouv√©e');
                return null;
            }
            
            // R√©cup√©rer mission au d√©marrage
            window.missionPatchState.currentMission = getCurrentMission();
            console.log('üìã Mission active:', window.missionPatchState.currentMission);
            
            // ========== SAUVEGARDE AM√âLIOR√âE ==========
            async function saveToServer(endpoint, data, description) {
                try {
                    console.log(`üíæ ${description}...`);
                    
                    const mission = getCurrentMission();
                    if (!mission || !mission.id) {
                        console.warn(`‚ö†Ô∏è ${description} - Mode offline (pas d'ID mission)`);
                        showToast(`${description} - Mode offline`, 'warning');
                        return { success: false, offline: true };
                    }
                    
                    const response = await fetch(`https://fiableauto-production-production.up.railway.app/api${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur API ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`‚úÖ ${description} - Succ√®s serveur:`, result);
                    showToast(`‚úÖ ${description} r√©ussie`, 'success');
                    return { success: true, data: result };
                    
                } catch (error) {
                    console.error(`‚ùå ${description} - Erreur:`, error);
                    showToast(`‚ùå ${description} - Erreur: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }
            
            async function updateMissionStatus(status, description) {
                try {
                    console.log(`üîÑ Mise √† jour statut: ${status}...`);
                    
                    const mission = getCurrentMission();
                    if (!mission || !mission.id) {
                        console.warn(`‚ö†Ô∏è Update statut - Pas d'ID mission`);
                        showToast('‚ö†Ô∏è Mission non identifi√©e pour sauvegarde', 'warning');
                        return false;
                    }
                    
                    const response = await fetch(`https://fiableauto-production-production.up.railway.app/api/missions/${mission.id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur API ${response.status}`);
                    }
                    
                    console.log(`‚úÖ Statut mis √† jour: ${status}`);
                    showToast(`‚úÖ ${description}`, 'success');
                    return true;
                    
                } catch (error) {
                    console.error(`‚ùå Erreur mise √† jour statut:`, error);
                    showToast(`‚ùå Erreur sauvegarde: ${error.message}`, 'error');
                    return false;
                }
            }
            
            // ========== OPTIMISATIONS DE BASE ==========
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.style.fontSize = '16px';
                textarea.removeAttribute('readonly');
            });
            
            // ========== PHOTOS AVEC DEBUG ==========
            document.querySelectorAll('#departurePhotos input[type="file"], #arrivalPhotos input[type="file"]').forEach(input => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                const card = newInput.closest('.photo-card');
                const phase = newInput.closest('#departurePhotos') ? 'departure' : 'arrival';
                const photoType = newInput.dataset.photo;
                
                newInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    console.log(`üì∏ Upload photo: ${phase}:${photoType}`);
                    
                    try {
                        // Validation
                        if (!file.type.startsWith('image/')) {
                            throw new Error('Le fichier doit √™tre une image');
                        }
                        
                        // Preview local
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            let preview = card.querySelector('.photo-preview');
                            if (!preview) {
                                preview = document.createElement('img');
                                preview.className = 'photo-preview';
                                preview.style.cssText = 'max-width: 100%; max-height: 120px; border-radius: 6px; margin-top: 8px; display: block;';
                                card.appendChild(preview);
                            }
                            preview.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        
                        // Marquer comme upload√©e
                        card.classList.add('uploaded');
                        window.missionPatchState.uploadedFiles[phase].set(photoType, file);
                        
                        // Upload serveur
                        const mission = getCurrentMission();
                        if (mission && mission.id) {
                            try {
                                const formData = new FormData();
                                formData.append('photo', file);
                                formData.append('photoType', `${phase}:${photoType}`);
                                
                                const response = await fetch(`https://fiableauto-production-production.up.railway.app/api/uploads/photos/${mission.id}`, {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                if (response.ok) {
                                    console.log(`‚úÖ Photo ${photoType} upload√©e sur serveur`);
                                } else {
                                    console.warn(`‚ö†Ô∏è Upload serveur √©chou√© pour ${photoType}`);
                                }
                            } catch (uploadError) {
                                console.warn(`‚ö†Ô∏è Erreur upload serveur:`, uploadError);
                            }
                        }
                        
                        updateCounters();
                        showToast(`üì∏ Photo ${photoType} ajout√©e`, 'success');
                        
                    } catch (error) {
                        console.error('Erreur upload:', error);
                        showToast(`Erreur: ${error.message}`, 'error');
                    }
                });
                
                card.addEventListener('click', function(e) {
                    if (e.target !== newInput) {
                        newInput.click();
                    }
                });
            });
            
            // ========== CHECKBOXES ==========
            document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
                const newCheckbox = checkbox.cloneNode(true);
                checkbox.parentNode.replaceChild(newCheckbox, checkbox);
                
                newCheckbox.addEventListener('change', function() {
                    window.missionPatchState.checkboxes = document.querySelectorAll('#checklist input:checked').length;
                    console.log('‚òëÔ∏è Checkboxes coch√©es:', window.missionPatchState.checkboxes);
                    updateCounters();
                });
            });
            
            // ========== VALIDATION D√âPART AVEC DEBUG ==========
            const validateBtn = document.getElementById('validateDeparture');
            if (validateBtn) {
                const newValidateBtn = validateBtn.cloneNode(true);
                validateBtn.parentNode.replaceChild(newValidateBtn, validateBtn);
                
                newValidateBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    console.log('üîò VALIDATION D√âPART - D√©but');
                    console.log('- Checkboxes:', window.missionPatchState.checkboxes);
                    console.log('- Photos d√©part:', window.missionPatchState.departurePhotos);
                    console.log('- Mission:', window.missionPatchState.currentMission);
                    
                    // V√©rifications
                    if (window.missionPatchState.checkboxes < 5) {
                        showToast('‚ùå Cochez les 5 cases de la checklist', 'warning');
                        return;
                    }
                    
                    if (window.missionPatchState.departurePhotos < 10) {
                        showToast('‚ùå Ajoutez les 10 photos de d√©part', 'warning');
                        return;
                    }
                    
                    // Loading
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';
                    
                    try {
                        // Sauvegarder donn√©es d√©part
                        const mission = getCurrentMission();
                        if (mission && mission.id) {
                            const departureData = {
                                phase: 'departure',
                                observations: document.getElementById('departureObservations')?.value || '',
                                checklist: getChecklistData(),
                                photos: Array.from(window.missionPatchState.uploadedFiles.departure.keys()),
                                timestamp: new Date().toISOString()
                            };
                            
                            console.log('üíæ Donn√©es d√©part √† sauvegarder:', departureData);
                            
                            await saveToServer(`/missions/${mission.id}/departure-data`, departureData, 'Sauvegarde d√©part');
                            const statusUpdated = await updateMissionStatus('departure_validated', 'EDL D√©part valid√©');
                            
                            if (statusUpdated) {
                                console.log('‚úÖ Mission marqu√©e comme departure_validated dans la base');
                            }
                        }
                        
                        // Interface
                        window.missionPatchState.departureValidated = true;
                        this.innerHTML = '‚úÖ D√©part Valid√©';
                        this.style.background = '#10b981';
                        
                        // Transition
                        setTimeout(() => {
                            document.getElementById('departurePhase').style.display = 'none';
                            const arrivalPhase = document.getElementById('arrivalPhase');
                            arrivalPhase.style.display = 'block';
                            arrivalPhase.scrollIntoView({ behavior: 'smooth' });
                        }, 1000);
                        
                        console.log('‚úÖ VALIDATION D√âPART - Succ√®s');
                        
                    } catch (error) {
                        console.error('‚ùå VALIDATION D√âPART - Erreur:', error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i> Valider D√©part';
                        showToast('Erreur validation: ' + error.message, 'error');
                    }
                });
            }
            
            // ========== FINALISATION AVEC DEBUG COMPLET ==========
            const finalizeBtn = document.getElementById('finalizeMission');
            if (finalizeBtn) {
                const newFinalizeBtn = finalizeBtn.cloneNode(true);
                finalizeBtn.parentNode.replaceChild(newFinalizeBtn, finalizeBtn);
                
                newFinalizeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    console.log('üèÅ FINALISATION - D√©but');
                    console.log('- D√©part valid√©:', window.missionPatchState.departureValidated);
                    console.log('- Photos arriv√©e:', window.missionPatchState.arrivalPhotos);
                    console.log('- Mission:', window.missionPatchState.currentMission);
                    
                    // V√©rifications
                    if (!window.missionPatchState.departureValidated) {
                        showToast('‚ùå Validez d\'abord l\'EDL D√©part', 'warning');
                        return;
                    }
                    
                    if (window.missionPatchState.arrivalPhotos < 3) {
                        showToast('‚ùå Ajoutez les 3 photos d\'arriv√©e', 'warning');
                        return;
                    }
                    
                    // Loading
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalisation...';
                    
                    try {
                        // Sauvegarder donn√©es arriv√©e
                        const mission = getCurrentMission();
                        if (mission && mission.id) {
                            const arrivalData = {
                                phase: 'arrival',
                                observations: document.getElementById('arrivalObservations')?.value || '',
                                signature: getSignatureData(),
                                photos: Array.from(window.missionPatchState.uploadedFiles.arrival.keys()),
                                timestamp: new Date().toISOString()
                            };
                            
                            console.log('üíæ Donn√©es arriv√©e √† sauvegarder:', arrivalData);
                            
                            await saveToServer(`/missions/${mission.id}/arrival-data`, arrivalData, 'Sauvegarde arriv√©e');
                            const statusUpdated = await updateMissionStatus('completed', 'Mission finalis√©e');
                            
                            if (statusUpdated) {
                                console.log('üéâ MISSION MARQU√âE COMME COMPLETED DANS LA BASE !');
                                
                                // Recharger les stats du gestionnaire si possible
                                if (window.app && typeof window.app.loadStats === 'function') {
                                    setTimeout(() => {
                                        window.app.loadStats();
                                        window.app.loadAllMissions();
                                        console.log('üîÑ Stats gestionnaire recharg√©es');
                                    }, 2000);
                                }
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Finalisation sans ID mission - Mode offline');
                        }
                        
                        // Interface
                        window.missionPatchState.missionCompleted = true;
                        this.innerHTML = 'üéâ Mission Finalis√©e';
                        this.style.background = '#10b981';
                        
                        // √âcran de succ√®s avec info debug
                        showCompletionScreen(mission);
                        
                        console.log('‚úÖ FINALISATION - Succ√®s complet');
                        
                    } catch (error) {
                        console.error('‚ùå FINALISATION - Erreur:', error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check-double"></i> Finaliser Mission';
                        showToast('Erreur finalisation: ' + error.message, 'error');
                    }
                });
            }
            
            // ========== FONCTIONS UTILITAIRES ==========
            function updateCounters() {
                window.missionPatchState.departurePhotos = document.querySelectorAll('#departurePhotos .uploaded').length;
                window.missionPatchState.arrivalPhotos = document.querySelectorAll('#arrivalPhotos .uploaded').length;
                
                console.log(`üìä Compteurs: D√©part=${window.missionPatchState.departurePhotos}, Arriv√©e=${window.missionPatchState.arrivalPhotos}`);
                
                updateButtons();
            }
            
            function updateButtons() {
                // Validation d√©part
                const validateBtn = document.getElementById('validateDeparture');
                if (validateBtn && !window.missionPatchState.departureValidated) {
                    const canValidate = window.missionPatchState.checkboxes >= 5 && window.missionPatchState.departurePhotos >= 10;
                    validateBtn.disabled = !canValidate;
                    validateBtn.style.opacity = canValidate ? '1' : '0.6';
                    
                    if (canValidate) {
                        validateBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        validateBtn.innerHTML = '<i class="fas fa-check-circle"></i> VALIDER D√âPART';
                    }
                }
                
                // Finalisation
                const finalizeBtn = document.getElementById('finalizeMission');
                if (finalizeBtn && !window.missionPatchState.missionCompleted) {
                    const canFinalize = window.missionPatchState.departureValidated && window.missionPatchState.arrivalPhotos >= 3;
                    finalizeBtn.disabled = !canFinalize;
                    finalizeBtn.style.opacity = canFinalize ? '1' : '0.6';
                    
                    if (canFinalize) {
                        finalizeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        finalizeBtn.innerHTML = '<i class="fas fa-trophy"></i> FINALISER MISSION';
                    }
                }
            }
            
            function getChecklistData() {
                const data = {};
                document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
                    data[checkbox.name] = checkbox.checked;
                });
                return data;
            }
            
            function getSignatureData() {
                const canvas = document.getElementById('signatureCanvas');
                if (!canvas) return null;
                
                const ctx = canvas.getContext('2d');
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                for (let i = 0; i < imgData.data.length; i += 4) {
                    if (imgData.data[i + 3] !== 0) {
                        return canvas.toDataURL('image/png');
                    }
                }
                return null;
            }
            
            function showToast(message, type) {
                console.log(`üîî Toast: ${message} (${type})`);
                
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 300px;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                requestAnimationFrame(() => toast.style.transform = 'translateX(0)');
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 5000);
            }
            
            function showCompletionScreen(mission) {
                // Masquer interface mission
                const missionDetails = document.getElementById('missionDetails');
                if (missionDetails) missionDetails.style.display = 'none';
                
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const missionInfo = mission ? `Mission ${mission.mission_code || mission.id} finalis√©e` : 'Mission finalis√©e';
                
                overlay.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center; max-width: 400px; width: 90%;">
                        <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">üéâ</div>
                        <h2 style="color: #10b981; font-size: 2rem; margin-bottom: 1rem;">Mission Finalis√©e!</h2>
                        <p style="color: #64748b; margin-bottom: 1rem;">${missionInfo}</p>
                        <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 1rem;">Sauvegard√©e avec statut: <strong>completed</strong></p>
                        <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 2rem;">V√©rifiez dans l'onglet Gestionnaire > Missions termin√©es</p>
                        <button onclick="location.reload()" style="background: #f97316; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                            üè† Retour Accueil
                        </button>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                console.log('‚úÖ √âcran de completion affich√©');
            }
            
            // Initialisation
            updateCounters();
            
            console.log('‚úÖ Patch debug appliqu√© avec succ√®s');
            showToast('üîß Interface debug activ√©e - V√©rifiez la console', 'info');
            
        } catch (error) {
            console.error('‚ùå Erreur patch debug:', error);
        }
        
    }, 3000); // Attendre 3 secondes
    
})();
</script>

  </body>
</html>

