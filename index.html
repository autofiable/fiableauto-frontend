<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiableAuto ‚Äì Web App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body data-theme="light">
  <header>
    <h1>üöó FiableAuto</h1>
  </header>

  <!-- Navigation -->
  <nav class="nav">
    <button class="nav-pill active" data-section="gestionnaire"><i class="fas fa-user-tie"></i> Gestionnaire</button>
    <button class="nav-pill" data-section="prestataire"><i class="fas fa-user-cog"></i> Prestataire</button>
    <button class="nav-pill" data-section="client"><i class="fas fa-user"></i> Client</button>
  </nav>

  <!-- GESTIONNAIRE -->
  <section id="gestionnaire" class="section active">
    <!-- Stats Dashboard -->
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalMissions">0</h3>
          <p>Missions cr√©√©es</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingMissions">0</h3>
          <p>En attente</p>
        </div>
        <div class="stat-card">
          <h3 id="progressMissions">0</h3>
          <p>En cours</p>
        </div>
        <div class="stat-card">
          <h3 id="completedMissions">0</h3>
          <p>Termin√©es</p>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>Cr√©er une mission</h2>
      <form id="missionForm" class="enhanced-form">
        <div class="form-grid">
          <input type="text" name="vehicleBrand" placeholder="Marque" required>
          <input type="text" name="vehicleModel" placeholder="Mod√®le" required>
          <input type="number" name="vehicleYear" placeholder="Ann√©e">
          <input type="text" name="licensePlate" placeholder="Immatriculation">
          <input type="number" name="mileage" placeholder="Kilom√©trage">
          <input type="text" name="pickupLocation" placeholder="Lieu prise en charge" required>
          <input type="text" name="deliveryLocation" placeholder="Lieu livraison" required>
          <input type="date" name="pickupDate">
          <input type="date" name="deliveryDate">
          <input type="text" name="clientName" placeholder="Nom client" required>
          <input type="email" name="clientEmail" placeholder="Email client" required>
          <input type="text" name="clientPhone" placeholder="T√©l√©phone client">
        </div>
        <button type="submit" class="btn-enhanced btn-primary">Cr√©er mission</button>
      </form>

      <h3>Missions archiv√©es</h3>
      <div id="missionsList"></div>
    </div>
  </section>

  <!-- PRESTATAIRE -->
  <section id="prestataire" class="section">
    <div class="container">
      <h2>Acc√©der √† une mission</h2>
      <form id="accessForm" class="enhanced-form">
        <input type="text" id="missionCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Acc√©der</button>
      </form>

      <div id="missionDetails" style="display:none; margin-top:20px;">
        <div id="missionInfo"></div>

        <!-- Phase D√©part -->
        <div id="departurePhase" class="mission-phase">
          <h3 class="phase-title"><i class="fas fa-play-circle"></i> Phase D√©part</h3>
          
          <!-- Checklist -->
          <div id="checklist" class="enhanced-form-section">
            <div class="section-title"><i class="fas fa-list-check"></i> Checklist</div>
            <label><input type="checkbox" name="vehiclePapers" value="ok"> Papiers v√©hicule OK</label>
            <label><input type="checkbox" name="gps" value="ok"> GPS fonctionnel</label>
            <label><input type="checkbox" name="sdCard" value="ok"> Carte SD pr√©sente</label>
            <label><input type="checkbox" name="safetyKit" value="ok"> Kit s√©curit√© complet</label>
            <label><input type="checkbox" name="spareWheel" value="ok"> Roue de secours</label>
          </div>

          <!-- Photos de d√©part AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos de d√©part</h4>
            <div class="photo-grid" id="departurePhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur</label>
                </div>
                <input type="file" data-photo="compteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car photo-icon"></i>
                  <label>Face avant</label>
                </div>
                <input type="file" data-photo="face-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-rear photo-icon"></i>
                  <label>Face arri√®re</label>
                </div>
                <input type="file" data-photo="face-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral gauche avant</label>
                </div>
                <input type="file" data-photo="lateral-gauche-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral gauche arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-gauche-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral droit avant</label>
                </div>
                <input type="file" data-photo="lateral-droit-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral droit arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-droit-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-cog photo-icon"></i>
                  <label>Moteur</label>
                </div>
                <input type="file" data-photo="moteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-chair photo-icon"></i>
                  <label>Int√©rieur</label>
                </div>
                <input type="file" data-photo="interieur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-book photo-icon"></i>
                  <label>Carnet d'entretien</label>
                </div>
                <input type="file" data-photo="carnet" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations de d√©part -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations de d√©part</h4>
            <textarea id="departureObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule au d√©part..."></textarea>
          </div>

          <button type="button" id="validateDeparture" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check"></i> Valider D√©part
          </button>
        </div>

        <!-- Phase Arriv√©e -->
        <div id="arrivalPhase" class="mission-phase" style="display:none;">
          <h3 class="phase-title"><i class="fas fa-flag-checkered"></i> Phase Arriv√©e</h3>
          
          <!-- Photos d'arriv√©e AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos d'arriv√©e</h4>
            <div class="photo-grid" id="arrivalPhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur final</label>
                </div>
                <input type="file" data-photo="compteur-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-crash photo-icon"></i>
                  <label>√âtat g√©n√©ral final</label>
                </div>
                <input type="file" data-photo="etat-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-key photo-icon"></i>
                  <label>Remise cl√©s</label>
                </div>
                <input type="file" data-photo="remise-cles" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations d'arriv√©e -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations d'arriv√©e</h4>
            <textarea id="arrivalObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule √† l'arriv√©e..."></textarea>
          </div>

          <!-- Signature client -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-signature"></i> Signature du client</h4>
            <div class="signature-section">
              <canvas id="signatureCanvas" width="500" height="200"></canvas>
              <div class="signature-controls">
                <button type="button" id="clearSignature" class="btn-enhanced btn-secondary">
                  <i class="fas fa-eraser"></i> Effacer
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="finalizeMission" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check-double"></i> Finaliser Mission
          </button>
        </div>

        <!-- √âcran de fin -->
        <div id="completionScreen" class="completion-screen" style="display:none;">
          <div class="completion-content">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>Mission Finalis√©e avec Succ√®s !</h3>
            <p>La mission a √©t√© compl√©t√©e et le rapport est disponible.</p>
            <button type="button" id="returnToHome" class="btn-enhanced btn-primary">
              <i class="fas fa-home"></i> Retour Accueil Prestataire
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENT -->
  <section id="client" class="section">
    <div class="container">
      <h2>Suivi de mission</h2>
      <form id="trackingForm" class="enhanced-form">
        <input type="text" id="trackingCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Suivre ma mission</button>
      </form>
      
      <div id="trackingResult" style="display:none;">
        <div id="trackingInfo"></div>
        
        <!-- Statut de progression -->
        <div id="progressTracker" class="progress-tracker">
          <div class="progress-step" data-step="created">
            <div class="step-icon"><i class="fas fa-plus"></i></div>
            <div class="step-label">Mission cr√©√©e</div>
          </div>
          <div class="progress-step" data-step="in-progress">
            <div class="step-icon"><i class="fas fa-road"></i></div>
            <div class="step-label">En cours</div>
          </div>
          <div class="progress-step" data-step="departure-validated">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div class="step-label">D√©part valid√©</div>
          </div>
          <div class="progress-step" data-step="completed">
            <div class="step-icon"><i class="fas fa-flag-checkered"></i></div>
            <div class="step-label">Termin√©e</div>
          </div>
        </div>

        <!-- Section rapport -->
        <div id="downloadSection" style="display:none;">
          <div class="report-section">
            <h4><i class="fas fa-file-pdf"></i> Rapport de mission</h4>
            <div class="report-actions">
              <button id="downloadReport" class="btn-enhanced btn-success">
                <i class="fas fa-download"></i> T√©l√©charger rapport PDF
              </button>
              <button id="emailReport" class="btn-enhanced btn-secondary">
                <i class="fas fa-envelope"></i> Envoyer par email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notifications et Loading -->
  <div id="notification" class="notification"></div>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
  </div>

  <script src="script.js"></script>

  <script src="script.js"></script>

<!-- üîß PATCH FINAL UNIQUE (remplace tous les autres) -->
<script>
(function() {
    console.log('üîß Application patch final...');
    
    setTimeout(function() {
        try {
            // Variables globales
            window.missionCompleted = false;
            window.departureValidated = false;
            
            // 1. FIX TEXTAREA
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.style.fontSize = '16px';
                textarea.removeAttribute('readonly');
            });
            
            // 2. FIX VALIDATION D√âPART (SANS ERREUR)
            const validateBtn = document.getElementById('validateDeparture');
            if (validateBtn) {
                validateBtn.onclick = null;
                validateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    try {
                        const checkboxes = document.querySelectorAll('#checklist input:checked').length;
                        const photos = document.querySelectorAll('#departurePhotos .photo-card.uploaded').length;
                        
                        if (checkboxes < 5 || photos < 10) {
                            alert('‚ùå V√©rifiez checklist et photos');
                            return;
                        }
                        
                        window.departureValidated = true;
                        this.disabled = true;
                        this.innerHTML = '‚úÖ D√©part Valid√©';
                        this.style.background = '#10b981';
                        
                        // Masquer EDL d√©part
                        setTimeout(() => {
                            document.getElementById('departurePhase').style.display = 'none';
                        }, 1000);
                        
                        // Afficher arriv√©e
                        const arrivalPhase = document.getElementById('arrivalPhase');
                        arrivalPhase.style.display = 'block';
                        setTimeout(() => arrivalPhase.scrollIntoView({behavior: 'smooth'}), 1500);
                        
                        alert('‚úÖ EDL D√©part valid√© !');
                        
                    } catch (error) {
                        // Continuer m√™me en cas d'erreur
                        this.disabled = true;
                        this.innerHTML = '‚úÖ Valid√©';
                        document.getElementById('arrivalPhase').style.display = 'block';
                    }
                });
            }
            
            // 3. FIX FINALISER MISSION
            const finalizeBtn = document.getElementById('finalizeMission');
            if (finalizeBtn) {
                finalizeBtn.onclick = null;
                finalizeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    try {
                        if (!window.departureValidated) {
                            alert('‚ùå Validez d\'abord le d√©part');
                            return;
                        }
                        
                        const arrivalPhotos = document.querySelectorAll('#arrivalPhotos .photo-card.uploaded').length;
                        if (arrivalPhotos < 3) {
                            alert('‚ùå Il faut les 3 photos d\'arriv√©e');
                            return;
                        }
                        
                        window.missionCompleted = true;
                        this.disabled = true;
                        this.innerHTML = 'üéâ Finalis√©e';
                        this.style.background = '#10b981';
                        
                        // AFFICHER √âCRAN DE COMPLETION
                        setTimeout(() => {
                            document.getElementById('missionDetails').style.display = 'none';
                            
                            let completionScreen = document.getElementById('completionScreen');
                            if (!completionScreen) {
                                completionScreen = document.createElement('div');
                                completionScreen.id = 'completionScreen';
                                completionScreen.innerHTML = `
                                    <div style="background: white; border-radius: 12px; padding: 2rem; text-align: center; margin: 2rem auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px solid #10b981; max-width: 500px;">
                                        <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">‚úÖ</div>
                                        <h3 style="color: #10b981; font-size: 2rem; margin-bottom: 1rem;">Mission Finalis√©e !</h3>
                                        <p style="color: #64748b; margin-bottom: 2rem;">La mission a √©t√© compl√©t√©e avec succ√®s.</p>
                                        <button onclick="returnToHome()" style="background: #f97316; color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                            üè† Retour Accueil
                                        </button>
                                    </div>
                                `;
                                document.getElementById('prestataire').appendChild(completionScreen);
                            }
                            
                            completionScreen.style.display = 'block';
                            setTimeout(() => completionScreen.scrollIntoView({behavior: 'smooth'}), 500);
                        }, 1000);
                        
                        alert('üéâ Mission finalis√©e !');
                        
                    } catch (error) {
                        alert('‚ùå Erreur: ' + error.message);
                    }
                });
            }
            
            // 4. FONCTION RETOUR ACCUEIL
            window.returnToHome = function() {
                window.departureValidated = false;
                window.missionCompleted = false;
                
                document.getElementById('completionScreen').style.display = 'none';
                document.getElementById('missionDetails').style.display = 'none';
                document.getElementById('accessForm').reset();
                
                document.getElementById('departurePhase').style.display = 'block';
                document.getElementById('arrivalPhase').style.display = 'none';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                alert('üîÑ Retour accueil');
            };
            
            console.log('‚úÖ Patch final appliqu√©');
            
        } catch (error) {
            console.error('‚ùå Erreur patch:', error);
        }
    }, 2000);
})();
</script>

</body>
</html>
