<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiableAuto ‚Äì Web App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body data-theme="light">
  <header>
    <h1>üöó FiableAuto</h1>
  </header>

  <!-- Navigation -->
  <nav class="nav">
    <button class="nav-pill active" data-section="gestionnaire"><i class="fas fa-user-tie"></i> Gestionnaire</button>
    <button class="nav-pill" data-section="prestataire"><i class="fas fa-user-cog"></i> Prestataire</button>
    <button class="nav-pill" data-section="client"><i class="fas fa-user"></i> Client</button>
  </nav>

  <!-- GESTIONNAIRE -->
  <section id="gestionnaire" class="section active">
    <!-- Stats Dashboard -->
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalMissions">0</h3>
          <p>Missions cr√©√©es</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingMissions">0</h3>
          <p>En attente</p>
        </div>
        <div class="stat-card">
          <h3 id="progressMissions">0</h3>
          <p>En cours</p>
        </div>
        <div class="stat-card">
          <h3 id="completedMissions">0</h3>
          <p>Termin√©es</p>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>Cr√©er une mission</h2>
      <form id="missionForm" class="enhanced-form">
        <div class="form-grid">
          <input type="text" name="vehicleBrand" placeholder="Marque" required>
          <input type="text" name="vehicleModel" placeholder="Mod√®le" required>
          <input type="number" name="vehicleYear" placeholder="Ann√©e">
          <input type="text" name="licensePlate" placeholder="Immatriculation">
          <input type="number" name="mileage" placeholder="Kilom√©trage">
          <input type="text" name="pickupLocation" placeholder="Lieu prise en charge" required>
          <input type="text" name="deliveryLocation" placeholder="Lieu livraison" required>
          <input type="date" name="pickupDate">
          <input type="date" name="deliveryDate">
          <input type="text" name="clientName" placeholder="Nom client" required>
          <input type="email" name="clientEmail" placeholder="Email client" required>
          <input type="text" name="clientPhone" placeholder="T√©l√©phone client">
        </div>
        <button type="submit" class="btn-enhanced btn-primary">Cr√©er mission</button>
      </form>

      <h3>Missions archiv√©es</h3>
      <div id="missionsList"></div>
    </div>
  </section>

  <!-- PRESTATAIRE -->
  <section id="prestataire" class="section">
    <div class="container">
      <h2>Acc√©der √† une mission</h2>
      <form id="accessForm" class="enhanced-form">
        <input type="text" id="missionCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Acc√©der</button>
      </form>

      <div id="missionDetails" style="display:none; margin-top:20px;">
        <div id="missionInfo"></div>

        <!-- Phase D√©part -->
        <div id="departurePhase" class="mission-phase">
          <h3 class="phase-title"><i class="fas fa-play-circle"></i> Phase D√©part</h3>
          
          <!-- Checklist -->
          <div id="checklist" class="enhanced-form-section">
            <div class="section-title"><i class="fas fa-list-check"></i> Checklist</div>
            <label><input type="checkbox" name="vehiclePapers" value="ok"> Papiers v√©hicule OK</label>
            <label><input type="checkbox" name="gps" value="ok"> GPS fonctionnel</label>
            <label><input type="checkbox" name="sdCard" value="ok"> Carte SD pr√©sente</label>
            <label><input type="checkbox" name="safetyKit" value="ok"> Kit s√©curit√© complet</label>
            <label><input type="checkbox" name="spareWheel" value="ok"> Roue de secours</label>
          </div>

          <!-- Photos de d√©part AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos de d√©part</h4>
            <div class="photo-grid" id="departurePhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur</label>
                </div>
                <input type="file" data-photo="compteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car photo-icon"></i>
                  <label>Face avant</label>
                </div>
                <input type="file" data-photo="face-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-rear photo-icon"></i>
                  <label>Face arri√®re</label>
                </div>
                <input type="file" data-photo="face-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral gauche avant</label>
                </div>
                <input type="file" data-photo="lateral-gauche-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral gauche arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-gauche-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon"></i>
                  <label>Lat√©ral droit avant</label>
                </div>
                <input type="file" data-photo="lateral-droit-avant" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-side photo-icon" style="transform: scaleX(-1);"></i>
                  <label>Lat√©ral droit arri√®re</label>
                </div>
                <input type="file" data-photo="lateral-droit-arriere" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-cog photo-icon"></i>
                  <label>Moteur</label>
                </div>
                <input type="file" data-photo="moteur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-chair photo-icon"></i>
                  <label>Int√©rieur</label>
                </div>
                <input type="file" data-photo="interieur" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-book photo-icon"></i>
                  <label>Carnet d'entretien</label>
                </div>
                <input type="file" data-photo="carnet" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations de d√©part -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations de d√©part</h4>
            <textarea id="departureObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule au d√©part..."></textarea>
          </div>

          <button type="button" id="validateDeparture" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check"></i> Valider D√©part
          </button>
        </div>

        <!-- Phase Arriv√©e -->
        <div id="arrivalPhase" class="mission-phase" style="display:none;">
          <h3 class="phase-title"><i class="fas fa-flag-checkered"></i> Phase Arriv√©e</h3>
          
          <!-- Photos d'arriv√©e AVEC IC√îNES -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-camera"></i> Photos d'arriv√©e</h4>
            <div class="photo-grid" id="arrivalPhotos">
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-tachometer-alt photo-icon"></i>
                  <label>Compteur final</label>
                </div>
                <input type="file" data-photo="compteur-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-car-crash photo-icon"></i>
                  <label>√âtat g√©n√©ral final</label>
                </div>
                <input type="file" data-photo="etat-final" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
              
              <div class="photo-card">
                <div class="photo-header">
                  <i class="fas fa-key photo-icon"></i>
                  <label>Remise cl√©s</label>
                </div>
                <input type="file" data-photo="remise-cles" accept="image/*" capture="environment" required>
                <div class="photo-preview"></div>
                <div class="upload-status"></div>
              </div>
            </div>
          </div>

          <!-- Observations d'arriv√©e -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-edit"></i> Observations d'arriv√©e</h4>
            <textarea id="arrivalObservations" placeholder="Notez ici vos observations sur l'√©tat du v√©hicule √† l'arriv√©e..."></textarea>
          </div>

          <!-- Signature client -->
          <div class="enhanced-form-section">
            <h4><i class="fas fa-signature"></i> Signature du client</h4>
            <div class="signature-section">
              <canvas id="signatureCanvas" width="500" height="200"></canvas>
              <div class="signature-controls">
                <button type="button" id="clearSignature" class="btn-enhanced btn-secondary">
                  <i class="fas fa-eraser"></i> Effacer
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="finalizeMission" class="btn-enhanced btn-success" disabled>
            <i class="fas fa-check-double"></i> Finaliser Mission
          </button>
        </div>

        <!-- √âcran de fin -->
        <div id="completionScreen" class="completion-screen" style="display:none;">
          <div class="completion-content">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>Mission Finalis√©e avec Succ√®s !</h3>
            <p>La mission a √©t√© compl√©t√©e et le rapport est disponible.</p>
            <button type="button" id="returnToHome" class="btn-enhanced btn-primary">
              <i class="fas fa-home"></i> Retour Accueil Prestataire
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENT -->
  <section id="client" class="section">
    <div class="container">
      <h2>Suivi de mission</h2>
      <form id="trackingForm" class="enhanced-form">
        <input type="text" id="trackingCode" placeholder="Code mission" required>
        <button type="submit" class="btn-enhanced btn-primary">Suivre ma mission</button>
      </form>
      
      <div id="trackingResult" style="display:none;">
        <div id="trackingInfo"></div>
        
        <!-- Statut de progression -->
        <div id="progressTracker" class="progress-tracker">
          <div class="progress-step" data-step="created">
            <div class="step-icon"><i class="fas fa-plus"></i></div>
            <div class="step-label">Mission cr√©√©e</div>
          </div>
          <div class="progress-step" data-step="in-progress">
            <div class="step-icon"><i class="fas fa-road"></i></div>
            <div class="step-label">En cours</div>
          </div>
          <div class="progress-step" data-step="departure-validated">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div class="step-label">D√©part valid√©</div>
          </div>
          <div class="progress-step" data-step="completed">
            <div class="step-icon"><i class="fas fa-flag-checkered"></i></div>
            <div class="step-label">Termin√©e</div>
          </div>
        </div>

        <!-- Section rapport -->
        <div id="downloadSection" style="display:none;">
          <div class="report-section">
            <h4><i class="fas fa-file-pdf"></i> Rapport de mission</h4>
            <div class="report-actions">
              <button id="downloadReport" class="btn-enhanced btn-success">
                <i class="fas fa-download"></i> T√©l√©charger rapport PDF
              </button>
              <button id="emailReport" class="btn-enhanced btn-secondary">
                <i class="fas fa-envelope"></i> Envoyer par email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notifications et Loading -->
  <div id="notification" class="notification"></div>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
  </div>

  <script src="script.js"></script>

<!-- üîß PATCH CORRIG√â - PR√âSERVE LA NAVIGATION -->

<script>
// üîß PATCH MOBILE L√âGER - Garde la navigation fonctionnelle
(function() {
    'use strict';
    
    console.log('üîß Patch mobile l√©ger - Pr√©servation navigation...');
    
    // Attendre que l'app principale soit charg√©e
    setTimeout(function() {
        try {
            // ========== VARIABLES GLOBALES ==========
            window.missionPatchState = {
                departureValidated: false,
                missionCompleted: false,
                departurePhotos: 0,
                arrivalPhotos: 0,
                checkboxes: 0,
                uploadedFiles: {
                    departure: new Map(),
                    arrival: new Map()
                }
            };
            
            // ========== PR√âSERVER NAVIGATION EXISTANTE ==========
            // NE PAS toucher aux boutons de navigation !
            const navButtons = document.querySelectorAll('.nav-pill');
            console.log('üìç Navigation pr√©serv√©e:', navButtons.length, 'boutons');
            
            // ========== OPTIMISATIONS TEXTAREA SEULEMENT ==========
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.style.fontSize = '16px';
                textarea.removeAttribute('readonly');
                
                // Fix pour mobile
                textarea.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.focus();
                }, { passive: false });
            });
            
            // ========== PHOTOS UPLOAD AM√âLIOR√â ==========
            document.querySelectorAll('#departurePhotos input[type="file"], #arrivalPhotos input[type="file"]').forEach(input => {
                // Supprimer seulement les listeners de photos
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                const card = newInput.closest('.photo-card');
                const phase = newInput.closest('#departurePhotos') ? 'departure' : 'arrival';
                const photoType = newInput.dataset.photo;
                
                // Nouvel event listener optimis√©
                newInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        // Validation simple
                        if (!file.type.startsWith('image/') || file.size > 10 * 1024 * 1024) {
                            throw new Error('Fichier invalide (max 10MB, image uniquement)');
                        }
                        
                        // Preview local
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            let preview = card.querySelector('.photo-preview');
                            if (!preview) {
                                preview = document.createElement('img');
                                preview.className = 'photo-preview';
                                preview.style.cssText = 'max-width: 100%; max-height: 120px; border-radius: 6px; margin-top: 8px; display: block;';
                                card.appendChild(preview);
                            }
                            preview.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        
                        // Marquer comme upload√©e
                        card.classList.add('uploaded');
                        window.missionPatchState.uploadedFiles[phase].set(photoType, file);
                        
                        // Upload serveur si mission disponible
                        if (window.app && window.app.currentMission) {
                            await uploadToServer(window.app.currentMission.id, `${phase}:${photoType}`, file);
                        }
                        
                        // Mettre √† jour compteurs
                        updateCounters();
                        
                        showToast(`üì∏ Photo ${photoType} ajout√©e`, 'success');
                        
                    } catch (error) {
                        console.error('Erreur upload:', error);
                        showToast(`Erreur: ${error.message}`, 'error');
                        card.classList.add('upload-error');
                    }
                });
                
                // Click sur card
                card.addEventListener('click', function(e) {
                    if (e.target !== newInput && !newInput.disabled) {
                        newInput.click();
                    }
                });
            });
            
            // ========== CHECKBOXES AM√âLIOR√âES ==========
            document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
                // Supprimer ancien listener
                const newCheckbox = checkbox.cloneNode(true);
                checkbox.parentNode.replaceChild(newCheckbox, checkbox);
                
                newCheckbox.addEventListener('change', function() {
                    window.missionPatchState.checkboxes = document.querySelectorAll('#checklist input:checked').length;
                    updateCounters();
                    
                    // Visual feedback
                    const label = this.closest('label');
                    if (label) {
                        label.style.backgroundColor = this.checked ? 'rgba(16, 185, 129, 0.1)' : '';
                        label.style.borderColor = this.checked ? '#10b981' : '';
                    }
                });
            });
            
            // ========== VALIDATION D√âPART CORRIG√âE ==========
            const validateBtn = document.getElementById('validateDeparture');
            if (validateBtn) {
                // Supprimer ancien listener
                const newValidateBtn = validateBtn.cloneNode(true);
                validateBtn.parentNode.replaceChild(newValidateBtn, validateBtn);
                
                newValidateBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    try {
                        // V√©rifications
                        if (window.missionPatchState.checkboxes < 5) {
                            showToast('‚ùå Cochez les 5 cases de la checklist', 'warning');
                            return;
                        }
                        
                        if (window.missionPatchState.departurePhotos < 10) {
                            showToast('‚ùå Ajoutez les 10 photos de d√©part', 'warning');
                            return;
                        }
                        
                        // Loading state
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';
                        
                        // Sauvegarde serveur
                        if (window.app && window.app.currentMission) {
                            const departureData = {
                                phase: 'departure',
                                observations: document.getElementById('departureObservations')?.value || '',
                                checklist: getChecklistData(),
                                photos: Array.from(window.missionPatchState.uploadedFiles.departure.keys()),
                                timestamp: new Date().toISOString()
                            };
                            
                            await fetch('https://fiableauto-production-production.up.railway.app/api/missions/' + window.app.currentMission.id + '/departure-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(departureData)
                            });
                            
                            await fetch('https://fiableauto-production-production.up.railway.app/api/missions/' + window.app.currentMission.id + '/status', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: 'departure_validated' })
                            });
                        }
                        
                        // Succ√®s
                        window.missionPatchState.departureValidated = true;
                        this.innerHTML = '‚úÖ D√©part Valid√©';
                        this.style.background = '#10b981';
                        
                        // Transition vers arriv√©e
                        document.getElementById('departurePhase').style.display = 'none';
                        const arrivalPhase = document.getElementById('arrivalPhase');
                        arrivalPhase.style.display = 'block';
                        arrivalPhase.scrollIntoView({ behavior: 'smooth' });
                        
                        showToast('‚úÖ EDL D√©part valid√© et sauvegard√©', 'success');
                        
                    } catch (error) {
                        console.error('Erreur validation:', error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i> Valider D√©part';
                        showToast('Erreur validation: ' + error.message, 'error');
                    }
                });
            }
            
            // ========== FINALISATION CORRIG√âE ==========
            const finalizeBtn = document.getElementById('finalizeMission');
            if (finalizeBtn) {
                // Supprimer ancien listener
                const newFinalizeBtn = finalizeBtn.cloneNode(true);
                finalizeBtn.parentNode.replaceChild(newFinalizeBtn, finalizeBtn);
                
                newFinalizeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    try {
                        // V√©rifications
                        if (!window.missionPatchState.departureValidated) {
                            showToast('‚ùå Validez d\'abord l\'EDL D√©part', 'warning');
                            return;
                        }
                        
                        if (window.missionPatchState.arrivalPhotos < 3) {
                            showToast('‚ùå Ajoutez les 3 photos d\'arriv√©e', 'warning');
                            return;
                        }
                        
                        // Loading state
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalisation...';
                        
                        // Sauvegarde serveur
                        if (window.app && window.app.currentMission) {
                            const arrivalData = {
                                phase: 'arrival',
                                observations: document.getElementById('arrivalObservations')?.value || '',
                                signature: getSignatureData(),
                                photos: Array.from(window.missionPatchState.uploadedFiles.arrival.keys()),
                                timestamp: new Date().toISOString()
                            };
                            
                            await fetch('https://fiableauto-production-production.up.railway.app/api/missions/' + window.app.currentMission.id + '/arrival-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(arrivalData)
                            });
                            
                            await fetch('https://fiableauto-production-production.up.railway.app/api/missions/' + window.app.currentMission.id + '/status', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: 'completed' })
                            });
                        }
                        
                        // Succ√®s
                        window.missionPatchState.missionCompleted = true;
                        this.innerHTML = 'üéâ Mission Finalis√©e';
                        this.style.background = '#10b981';
                        
                        // √âcran de succ√®s
                        showCompletionScreen();
                        showToast('üéâ Mission finalis√©e avec succ√®s!', 'success');
                        
                    } catch (error) {
                        console.error('Erreur finalisation:', error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check-double"></i> Finaliser Mission';
                        showToast('Erreur finalisation: ' + error.message, 'error');
                    }
                });
            }
            
            // ========== FONCTIONS UTILITAIRES ==========
            async function uploadToServer(missionId, photoType, file) {
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('photoType', photoType);
                
                const response = await fetch(`https://fiableauto-production-production.up.railway.app/api/uploads/photos/${missionId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Upload serveur √©chou√©');
                return response.json();
            }
            
            function updateCounters() {
                window.missionPatchState.departurePhotos = document.querySelectorAll('#departurePhotos .uploaded').length;
                window.missionPatchState.arrivalPhotos = document.querySelectorAll('#arrivalPhotos .uploaded').length;
                
                // Mettre √† jour boutons
                updateValidationButton();
                updateFinalizationButton();
            }
            
            function updateValidationButton() {
                const btn = document.getElementById('validateDeparture');
                if (!btn || window.missionPatchState.departureValidated) return;
                
                const canValidate = window.missionPatchState.checkboxes >= 5 && window.missionPatchState.departurePhotos >= 10;
                btn.disabled = !canValidate;
                btn.style.opacity = canValidate ? '1' : '0.6';
                
                if (canValidate) {
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> VALIDER D√âPART';
                }
            }
            
            function updateFinalizationButton() {
                const btn = document.getElementById('finalizeMission');
                if (!btn || window.missionPatchState.missionCompleted) return;
                
                const canFinalize = window.missionPatchState.departureValidated && window.missionPatchState.arrivalPhotos >= 3;
                btn.disabled = !canFinalize;
                btn.style.opacity = canFinalize ? '1' : '0.6';
                
                if (canFinalize) {
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    btn.innerHTML = '<i class="fas fa-trophy"></i> FINALISER MISSION';
                }
            }
            
            function getChecklistData() {
                const data = {};
                document.querySelectorAll('#checklist input[type="checkbox"]').forEach(checkbox => {
                    data[checkbox.name] = checkbox.checked;
                });
                return data;
            }
            
            function getSignatureData() {
                const canvas = document.getElementById('signatureCanvas');
                if (!canvas) return null;
                
                const ctx = canvas.getContext('2d');
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // V√©rifier si signature pr√©sente
                for (let i = 0; i < imgData.data.length; i += 4) {
                    if (imgData.data[i + 3] !== 0) {
                        return canvas.toDataURL('image/png');
                    }
                }
                return null;
            }
            
            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 300px;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                requestAnimationFrame(() => toast.style.transform = 'translateX(0)');
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 4000);
            }
            
            function showCompletionScreen() {
                // Masquer interface mission
                const missionDetails = document.getElementById('missionDetails');
                if (missionDetails) missionDetails.style.display = 'none';
                
                // Cr√©er √©cran succ√®s
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                overlay.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center; max-width: 400px; width: 90%;">
                        <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">‚úÖ</div>
                        <h2 style="color: #10b981; font-size: 2rem; margin-bottom: 1rem;">Mission Finalis√©e!</h2>
                        <p style="color: #64748b; margin-bottom: 1rem;">La mission a √©t√© compl√©t√©e et sauvegard√©e.</p>
                        <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 2rem;">Elle appara√Ætra dans les missions termin√©es.</p>
                        <button onclick="location.reload()" style="background: #f97316; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                            üè† Retour Accueil
                        </button>
                    </div>
                `;
                
                document.body.appendChild(overlay);
            }
            
            // Initialiser compteurs
            updateCounters();
            
            console.log('‚úÖ Patch mobile l√©ger appliqu√© - Navigation pr√©serv√©e');
            showToast('üîß Interface mobile optimis√©e', 'success');
            
        } catch (error) {
            console.error('‚ùå Erreur patch l√©ger:', error);
        }
        
    }, 2000); // Attendre que l'app principale soit charg√©e
    
})();
</script>

  </body>
</html>
